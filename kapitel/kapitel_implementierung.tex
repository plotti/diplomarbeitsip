\chapter{Implementierung des Spiel-Prototypen}

Dieses Kapitel befasst sich mit der Implementierung des Spiel-Prototypen mit distanzbasierter integrierter Sprachkommunikation auf Basis eines hybriden SIP-Unicast-Ansatzes in einer 3D-Umgebung und präsentiert ausgewählte Details und Probleme bei der Umsetzung. Hauptaugenmerk liegt dabei auf der technischen Umsetzung der in \textit{Kapitel3} vorgestellten distanzbasierten Sprachkommunikation, der Umsetzung der Zonenkonzepte und der Zusammenarbeit des 3D-Frameworks mit der VoIP-Anwendung.

\section{Voraussetzungen}
 \label{prototyp}
 \label{anforderungen}
 
Die Anforderungen an die zur Umsetzung der Implementierung des Prototypen eingesetzten VoIP-Komponenten leiten sich direkt aus den in Kapitel 3 gestellten Herausforderungen ab: Die VoIP-Komponente muss dem Client die Kontrolle über den gleichzeitigen Rufauf- und Abbau mehrerer Audioströme erlauben. Damit die Metapher der Luftübertragung realisiert werden kann, muss beim Abmischen die Lautstärke aller Ströme kontrollierbar sein. Zusätzliche Kriterien sind die Unterstützung der Änderung der Bitrate des Audiosignals oder die Kontrolle verschiedener Konnektivitätsstufen, um eine Unterscheidung in den Proxemik-Zonen vorzunehmen.

Was die Anforderungen an das 3D-Framework betrifft, zeigt die klassische Einteilung \cite{aarseth03} von Spielen in Spielegenres, dass vor allem 3D-Actionspiele und Echtzeit-Rollenspiele den größten Bedarf an einer ausgeprägten Sprachkommunikation haben, da sie den Echtzeit-Aspekt betonen und oft eine kollektive synchronisierte Zusammenarbeit mehrerer Spielergruppen benötigen. So sind bei der grafischen Umsetzung des Prototyps Lösungen gefragt, die eine virtuelle, detaillierte und realistische 3D-Welt darstellen können, in der der Spieler die Möglichkeit hat sich frei zu bewegen und mit anderen Spielern in Interaktion treten kann. 

%In dieser Arbeit besteht kein Anspruch darauf einen Spiel-Prototypen zu entwickeln, der einem ausgereiften 3D-Action- oder Echtzeit-Rollenspiel entspricht. Stattdessen soll der Einsatz beider Komponenten im Viereck \cite{lindley03}, \cite{gibbs05} (siehe Abbildung \ref{fig:spieledreieck}) aus Spielerlebnis, Spielsimulation, erzählerischem Aspekt und der Spielerinteraktion durch möglichst effektive und intuitive Einsatzmöglichkeit der Sprachkommunikation eine hohe Spielerinteraktion erreichen und durch eine möglichst realistische Umgebung eine hohe Simulationstiefe darstellen.  

%\begin{figure}[tbh]
%	\centering
%	\includegraphics[width=1.00\textwidth]{grafiken/spielgenredreieck.eps}
%	\caption{Viereck aus Spielerlebnis, Simulation, erzählerischem Aspekt und %Spielerinteraktion}
%	\label{fig:spieledreieck}
%\end{figure}

\section{Auswahl eines 3D-Frameworks}
Da die Entwicklung eines realistischen Spieles weit über das Thema der Arbeit hinausgeht und diese Aufgabe normalerweise von ganzen Teams über mehrere Monate oder Jahre bewältigt wird, sollen nach Möglichkeit bestehende Frameworks, eingesetzt werden, die die Steuerung eines Avatars in einer möglichst realistischen 3D Umgebung erlauben. 

\subsection{First-Person-Shooter-Frameworks}
Viele der bestehenden Frameworks für 3D-orientierte-Spiele basieren meist auf den Eigenenwicklungen großer Softwarestudios wie \textit{Idsoftware}\footnote{IdSoftware, Seite besucht 21.03.2008, http://www.idsoftware.com/} oder \textit{Epic Games}\footnote{Epic Games, Seite besucht 21.03.2008, http://www.unrealtechnology.com}. Obwohl der offene Quellcode dieser Spiele die Grundlage vieler Spiele\footnote{Wikipedia, Seite besucht: 21.03.2008,  http://en.wikipedia.org/wiki/Quake\_series} bildet, gestaltet sich dessen Anpassung des sehr schwierig, da dieser dafür nie wirklich vorgesehen war. 

Seit einigen Jahren sind auch komplette Neuentwicklungen wie \textit{Sauerbraten}\footnote{W. Oortmerssen, Seite besucht 21.03.2008, http://sauerbraten.org} oder \textit{Nexuiz}\footnote{Alientrap, Seite besucht 21.03.2008, http://www.alientrap.org/nexuiz/} speziell für 3D-Actionspiele geschrieben worden. Obwohl diese eine opulente Grafik, ausgereifte Spielbalance und durchdachte Steuerung bieten, ist die Modifikation der darunter liegenden Hauptbestandteile schwer. Technische Details der Netzwerk- und Audiokomponenten oder der eigentlichen Spielelogik sind teilweise nicht ausführlich dokumentiert und machen Änderungen sehr mühsam oder sehen diese gar nicht vor. 

\subsection{3D-Engines}
Eine Alternative zu 3D-Spiele-Frameworks bieten offene generische 3D-Engines, deren Fokus auf der möglichst komfortablen Darstellung von 3D-Grafiken liegt. Dazu werden meist die Details von Systembibliotheken wie \textit{Direct3D} oder \textit{OpenGL} abstrahiert und dem Entwickler ein Interface angeboten, das auf höheren Abstraktionsklassen basiert. Bekannte Vertreter sind \textit{Ogre3D}\footnote{TheOGRETeam, Seite besucht 22.03.2008,  http://www.ogre3d.org/} oder \textit{Irrlicht}\footnote{N. Gebhardt, Seite besucht 22.03.2008, http://irrlicht.sourceforge.net/}. 

\subsubsection{\textit{Irrlicht}}
\textit{Irrlicht} ist ein einfaches gut dokumentiertes Open-Source Framework in C++, das übliche 3D Features wie \textit{Collision Detection}, Animationen, \textit{Shading} und Texturen sowohl unter \textit{Windows}, \textit{Linux} als auch \textit{Mac OS} unterstützt. Der Hauptgrund für den Einsatz von Irrlicht liegt darin, dass die Konzepte der bestehenden Arbeit von Triebel \cite{triebel07g} verwendet werden konnten und so eine schnelle Entwicklung des Prototyps gewährleistet wurde. Da man bei Irrlicht das Spiel von Grund auf selbst gestaltet hat man so eine maximale Kontrolle über alle technischen Einzelheiten und Abläufe während des Spiels. Als zusätzlichen Anreiz existiert speziell für Irrlicht eine einfache plattform-übergreifende Audiobibliothek (\textit{IrrKlang}\footnote{Nikolaus Gebhardt, Seite besucht 15.04.2008, http://www.ambiera.com/irrklang}). Sie unterstützt Audioverarbeitung auf der nativen Ebene, realistisches \textit{3D-Audio-Rendering}, \textit{Multithreading} und kann über \textit{Plugins} erweitert werden. Diese bietet die Möglichkeit die Soundausgabe bestehender VoIP-Komponenten mit Irrlicht zu verbinden und zusätzlich eine 3D-Positionierung des Audiosignals erlauben. 

\section{Auswahl einer VoIP-Lösung}

Zwecks der Implementierung einer Sprachkommunikationslösung stehen mehrere Alternativen zur Verfügung: 

\begin{itemize}
	\item Bestehende Drittanbieter Lösungen können abgeändert werden, um den gestellten Ansprüchen zu genügen.
	\item Existierende VoIP Programme können durch Nutzung ihrer API genutzt werden, um während dem Spiel Audioinformationen zu übertragen.
	\item Bibliotheken oder \textit{Protokollstapel}, können genutzt werden um eigene VoIP Lösungen zu entwickeln.
\end{itemize}

Bisher werden im Spielebereich fast ausschließlich serverbasierte Drittanbieter Lösungen eingesetzt. Sie alle bieten Unterstützung für effiziente Audiocodecs und besitzen einen vergleichbaren Funktionsumfang und kommen deshalb als potenzielle Kandidaten für den Prototypen in Frage. Im VoIP-Telefoniebereich werden oft Produkte wie \textit{Skype} oder offene Pendants auf SIP-Basis eingesetzt, die oft eine offene API bieten und deshalb für den Einsatz im Prototypen untersucht werden. Gleichzeitig existieren viele bestehende offene SIP-Protokollstapel, mit denen eigene VoIP-Lösungen implementiert werden können. Da diese noch keinen Einsatz in Spielen fanden, ist eine Untersuchung auf deren Tauglichkeit für den Spieleprototypen besonders interessant. 

\subsection{Modifikation bisheriger Sprachkommunikationslösungen}
Die unter Spielern beliebtesten Lösungen sind \textit{Ventrilo}\footnote{Flagship Industries Inc., Programmversion 3.0.1, http://www.ventrilo.com}, \textit{Teamspeak}\footnote{TeamSpeak Systems GmbH, Programmversion 2.0.33.7, http://www.goteamspeak.com} und \textit{Mumble}\footnote{Thorvald Natvig, Programmversion 1.1.3, http://mumble.sourceforge.net}. Bei allen der drei Produkte handelt es sich um serverbasierte VoIP-Anwendungen. Die Software besteht aus einem Server- und Client-Modul, wobei die Clientsoftware frei erhältlich ist, für die Serverkomponente jedoch ab einer größeren Anzahl\footnote{Der TeamSpeak Endbenutzer-Lizenzvertrag erlaubt es eigene kostenlose private Server aufzusetzen, falls eine Maximalanzahl an 10 Serverinstanzen und 1000 Spielern nicht überschritten wird.} an Spielern eine kostenpflichtige Lizenz zu erwerben ist. 
Die Funktionsweise dieser Programme wurde bereits in Abschnitt  \ref{sprachprobleme} vorgestellt. Zwei der drei Programme scheiden im Vorfeld jedoch aus, da deren Lizenz es nicht erlaubt diese nach eigenen Vorstellungen anzupassen und diese auch keine offenen Schnittstellen bieten. \textit{Mumble} ist zwar dank seiner freien Lizenz als einziges modifizierbar, jedoch aufgrund der komplizierten Serverkonfiguration und einem komplexen Rechtesystem, das auf Gruppen und Regeln basiert, nicht einfach an die neuen Konzepte anzupassen. Zusätzlich zu den vorhandenen Problemen sind die drei Lösungen untereinander nicht kompatibel und bieten somit nur proprietäre Insellösungen. 

\subsection{Nutzung der API von VoIP-Anwendungen}

Es existieren verschiedene VoIP Programme, die alle als dezentralisierte Lösungen eingesetzt werden können. Solche Programme wie \textit{X-Lite}\footnote{Counterpath, Seite besucht 21.03.2008, http://www.xten.com}, \textit{Gizmo5}\footnote{SIPphone Inc, Seite besucht 21.03.2008, http://gizmo5.com} oder \textit{OpenWengo}\footnote{OpenWengo Inc, Seite besucht 21.03.2008, http://www.openwengo.org}, werden von Infrastruktur-Betreibern kostenlos angeboten, um den eigenen Marktanteil am VoIP-Markt zu erhöhen. Diese besitzen meist einen großen Funktionsumfang, lassen sich jedoch aufgrund bestehender Lizenzen nicht modifizieren und sind meist an die Nutzung der Infrastruktur eines bestimmten Betreibers gebunden.

Daneben existiert eine Vielzahl an spezieller ausgereifter Open-Source SIP-\textit{Softphone}-Lösungen wie 
\textit{Ekiga}\footnote{Damien Sandras, Seite besucht 24.03.2008, http://www.gnomemeeting.org/}, \textit{KPhone}\footnote{Jan Janak, Seite besucht 24.03.2008, http://sourceforge.net/projects/kphone} \textit{Linphone}\footnote{Antisip, Seite besucht 24.03.2008, http://www.linphone.org} oder \textit{Minisip}\footnote{Telecommunications System Laboratory, Seite besucht 25.03.2008, http://www.minisip.org}. Die API der meisten dieser Lösungen ist jedoch auf das Ausführen von Telefonaten und einige Sonderfunktionen beschränkt. Eine detaillierte Kontrolle einer lokalen Konferenz ist ausgeschlossen. 

%Eine ausführliche und aktuelle Übersicht vieler auf auf dem Markt erhältlichen SIP Clients und Server Anwendungen ist im Internet verfügbar\footnote{Wikipedia:Overview of SIP Software, Version 22.03.2008, http://en.wikipedia.org/wiki/List\_of\_SIP\_software}

\subsubsection{Skype}

Einen Sonderstatus genießt \textit{Skype}, dessen Einsatz in Betracht gezogen wurde da es eine tatsächlich dezentrale Architektur bietet. Das Programm \textit{Skype} des Unternehmens Skype Technologies\footnote{Skype Technologies, Seite besucht 23.03.2008, http://www.skype.com} bietet innerhalb des eigenen Netzwerkes von registrierten Skype Benutzern die Möglichkeit des Instant Messaging, des Dateitransfers und der kostenlosen Telefonie über das Internet.
Von den Mitbegründern der Tauschbörse \textit{Kazaa}\footnote{Internet Tauschbörse (Sharman Networks Ltd), Seite besucht 23.03.2008, http://www.kazaa.com} ins Leben gerufen, basiert Skype wie das Filesharingprogramm auf dem Peer-to-Peer-Prinzip. Die Vermittlung, die Gespräche und auch Dienste wie das Teilnehmerverzeichnis werden nicht von einem zentralen Server angeboten, sondern auf alle gleichberechtigten Teilnehmer (den so genannten Peers) verteilt. Lediglich für die Authentifizierung und die Abrechnung bedient sich Skype eines zentralen Back-End-Servers. Das Skype Netzwerk unterscheidet zwischen einfachen Benutzern (Ordinary Hosts genannt) und den Super-Nodes\footnote{Ordinary Hosts mit einer öffentlichen IP-Adresse und ausreichender Bandbreite, CPU-Leistung und Hauptspeicher}. 

%Super Nodes sind Ordinary Hosts mit einer öffentlichen IP-Adresse und ausreichender Bandbreite, CPU-Leistung und Hauptspeicher und dienen als Endpunkte für die anderen Hosts. Der Benutzer selber hat keinen Einfluss auf die Entscheidung, ob sein Rechner als Super Node fungiert oder nicht. In diesem Zusammenhang kann man bei Skype nicht von einer reinen P2P Architektur sprechen, da nicht alle beteiligten Rechner gleiche Aufgaben übernehmen. 

Die \textit{Skype} Technologie ermöglicht als einziges ein völlig dezentrales VoIP. Der Einsatz des \textit{Skype} Dienstes und der Clients ist kostenlos. Über das \textit{Skype-API }ist es auch für externe Programme möglich, auf die Funktionalitäten des \textit{Skype-Clients} zu nutzen. 

Wie sich jedoch beim Versuch einer Implementierung zeigte, sind in der kostenlosen/kostenpflichtigen Version nur Konferenzen mit bis zu 5/10 gleichzeitigen Teilnehmern möglich. Beide Versionen bieten auf Clientseite keine Kontrolle über die einzelnen Audioströme. So kann nur die Summe aller Audioströme empfangen werden. Die Clientanwendung ist nicht in der Lage, einzelne Audioströme auszublenden oder die Lautstärke einzelner Teilnehmer zu ändern.  

Zudem ist über die Technik, die von der Skype-Anwendung verwendet wird, nicht viel bekannt, da die gesamte Kommunikation per AES mit 256 Bit verschlüsselt wird. Dies erlaubt keine direkte Analyse des Audiostroms und auch nur den Einsatz der Originalsoftware. Somit bietet \textit{Skype} als einziger tatsächlicher dezentralisierter Client nicht alle Eigenschaften, um als mögliche Ausgangsgrundlage zu dienen. 

\subsubsection{Instant-Messaging-Anwendungen}
Als letzte Alternative existieren Peer-to-Peer Programme wie \textit{Microsoft-\-Net\-meeting}\footnote{Microsoft, Seite besucht 20.03.2008, http://de.wikipedia.org/wiki/NetMeeting}, \textit{Microsoft-Messenger}\footnote{Microsoft, Seite besucht 20.03.2008, http://messenger.live.com} oder \textit{Google Talk}\footnote{Google, Seite besucht 20.03.2008, http://www.google.com/talk} die jedoch nicht modifizierbar sind und nur sehr eingeschränkte Konferenzmöglichkeiten bieten. 

Es scheint, dass die Abstraktionsstufe von existierenden VoIP-Lösungen bereits zu sehr auf die Funktion der Programme als Softphone ausgelegt ist und so keines der untersuchten Produkte eine API anbietet, die über genügend Kontrolle über die einzelnen Audioströme besitzt. Deshalb wurde der Entschluss getroffen VoIP-Protokollstapel einzusetzen, um eine eigene Lösung zu entwickeln. 

\subsection{SIP-Protokollstapel}
%Das im Kapitel 4 vorgestellte SIP Protokoll und existierende Protokollstapel erfüllen die gestellten Anforderungen an den Prototypen. Da SIP ein generisches und offenes Protokoll ist, kann es benutzt werden, um beliebige Sitzungen mit einem oder mehreren Teilnehmern zu verwalten. Dabei ist es nicht auf Internet-Telefonie beschränkt, sondern kann Sitzungen zwischen beliebigen Multimediaströmen, Konferenzen oder Computerspielen herstellen. 

Da Zahlreiche Standard\-isier\-ungs-Organisationen wie \textit{IETF\footnote{IETF, Seite besucht 22.03.2008, http://www.ietf.org/html.charters/sip-charter.html}, 3GPP\footnote{3GPP, Seite besucht 22.03.2008, http://www.3gpp.org/}, International Packet Communications Consortium\footnote{IPCC, Seite besucht 22.03.2008, http://www.imsforum.org/}, IMTC\footnote{ITMC, Seite besucht 22.03.2008, http://www.imtc.org/} und PacketCable\footnote{PacketCable, Seite besucht 22.03.2008, http://www.packetcable.com/}}  bereits den Einsatz von SIP unterstützen, wurden vor allem SIP als Serverlösung und auf clientseite entsprechende Protokollstapel in Betracht gezogen.
%http://www.cs.columbia.edu/sip/

%Um eine funktionierende Implementierung in kürzester Zeit umzusetzen, wurden  existierende offene SIP Protokollstapel in Betracht gezogen. Dabei wurde zwischen server- und clientbasierten Komponenten unterschieden. 

%In der Open-Source Gemeinde wird das SIP-Protokoll auch zunehmend unterstützt. So existieren bereits etliche Clientanwendungen und zentrale Komponenten wie \textit{Proxys} und \textit{Registrare}. Darüber hinaus finden sich zahlreiche gut dokumentierte SIP-Protokollstapel und \textit{SDKs}. Es existieren auch Referenzimplementierungen, wie \textit{JAIN-SIP} \footnote{Sun Microsystems, Version 24.03.2008, http://jain-sip.dev.java.net}, die sowohl in kommerziellen Projekten aber auch zu Forschungszwecken eingesetzt werden. Der wichtigste Grund für den Einsatz von SIP ist, dass es alle Anforderungen für die Umsetzung des Prototyps unterstützt:

%\begin{itemize}
%	\item Offener Standard
%	\item Generisches Protokoll um Sitzungen zu verwalten
%	\item Detaillierte Signalisierung von RTP Audioströmen
%	\item Kontrolle über jeden einzelnen Audiostrom auf clientseite
%	\item Serverbasierte Lösungen möglich
%	\item Dezentralisierte Lösungen möglich
%\end{itemize}

\subsubsection{SIP-Server}
Für den Einsatz als Server bieten sich zwei große Pakete an, die beide den SIP-Standard nach RFC 3265 unterstützen. \textit{Asterisk}\footnote{Digium Inc, Programmversion 1.4.19, http://www.asterisk.org} unterstützt Voice-over-IP mit unterschiedlichen Protokollen  darunter sowohl SIP als auch das \textit{H323} Protokoll und bietet alle Möglichkeiten einer Anbindung an das Telefonnetz. 

Die Serveranwendung \textit{OpenSer}\footnote{AG Projects, Programmversion 1.3.1, http://www.openser.org} bietet ähnliche Funktionalität und kann als SIP-Proxy, Registrar, aber auch als Locations- und Applications-Server betrieben werden und bietet zusätzlich Unterstützung für das SIP-SIMPLE Protokoll. \textit{OpenSer} ist sowohl von eingebetteten System wie DSL-Routern bis zu großen Installationen mit mehreren Millionen Benutzern bei Internet Service Providern flexibel einsetzbar. Diese Eigenschaften haben den Ausschlag gegeben Openser als SIP Server einzusetzen. 

Darüber hinaus existieren noch Open-Source oder proprietäre SIP-Server-Lösungen, die hier nicht weiter erläutert werden. 

\subsubsection{SIP-Clients}
Zu den Plattform-übergreifenden SIP-Protokollstapeln, die die Funktionalität von SIP in größeren Anwendungen ermöglichen zählen Protokollstapel wie \textit{OpenSipStack}\footnote{Joegen Baclor, Seite besucht 22.03.2008, http://www.opensipstack.org} \textit{sipXtackLib}\footnote{SIPfoundry, Seite besucht 22.03.2008, http://www.sipfoundry.org} \textit{reSIProcate}\footnote{B. Kampen, Seite besucht 22.03.2008, http://www.resiprocate.org} oder \textit{PJSIP}\footnote{Benjamin Prijono, Seite besucht 22.03.2008, http://www.pjsip.org}. 

\subsubsection{Pjsip}
Viele der existierenden SIP-Clientanwendungen und Protokollstapel kamen für den Prototypen deshalb nicht in Frage, weil sie in einer anderen Programmiersprache als C oder C++ geschrieben waren und so nur mühsam in das 3D-Framework integriert werden könnten. Die Wahl fiel vor allem aufgrund seiner guten Dokmentation und Platformunabhängigkeit auf \textit{PjSIP}. Im Gegensatz zu anderen Kandidaten, bietet es auch Dank der Kombination aus SIP-Signalisierung und der Existenz eines Audiostapels die besten Vorraussetzungen, um eine schnelle Entwicklung zu gewährleisten. Es bietet außerdem eine Unterstüzung folgender in Kapitel 4 vorgestellten SIP-Funktionalitäten:
\begin{itemize}
	\item Unterstützung des SIP Standards (PJSIP-CORE)
	\item Unterstützung des SIP-SIMPLE Standards (PJSIP-SIMPLE)
	\item Unterstützung für STUN, TURN und ICE (PJLIB-UTIL)
	\item Unterstützung moderner Audiocodecs wie z.B. \textit{Speex} (PJMEDIA-CODEC)
	\item Bereits existierender Medienstapel (PJMEDIA)
	\item Unterstützung von \textit{Asterisk} und \textit{Openser}
	\item Kontrolle jedes einzelnen Audiostroms (PJSUA-LIB)
\end{itemize}

\begin{figure}[tbh]
	\centering
		\includegraphics[width=0.70\textwidth]{grafiken/pjsip.eps}
	\caption{Übersicht der Komponenten des PjSIP-Protokollstapels}
	\label{fig:pjsip}
\end{figure}

\section{Vorgehensweise bei der Implementierung des Prototypen}
\subsection{Programmiersprache und Testumgebung}
Der Einsatz von C und C++ als Programmiersprache wird durch mehrere Vorteile gerechtfertigt: Die Darstellung der virtuellen 3D-Welt und die die Etablierung, Verarbeitung und Wiedergabe der Audioströme bilden zusammen ein Echtzeitsystem. Da in so einem System der gleichzeitige zeitnahe Ablauf mehrerer Prozesse erforderlich ist, wird eine sehr performante Programmiersprache benötigt. Es sind vor allem kurze Reaktionszeiten erforderlich, um für den Spieler eine glaubwürdige Illusion zu erzeugen. Beim Audiosignal reichen bereits Verzögerungen von mehr als 300ms aus, um eine Verständigung unverständlich zu machen. 

Da C und C++ maschinennahe Sprachen sind, und keine Interpretation des Quellcodes während der Laufzeit benötigen, besitzen sie einen Effizienzvorteil gegenüber Sprachen eine hohe Abstraktionsebene besitzen oder während der Laufzeit interpretiert werden müssen. Gerade deswegen liegen fast alle bisher vorgestellten Protokollstapel und Bibliotheken für VoIP oder 3D-Grafik ausschließlich in C oder C++ vor. 

\subsubsection{Testumgebung}
\label{testumgebung}
Die wiederkehrenden Tests wurden auf diversen zur Verfügung stehenden Systemen
durchgeführt. Als Clients kamen \textit{AMD Athlon(tm)} X2Dual 4200+, \textit{IBM} \textit{Thinkpad} T42 1,6GHz, \textit{Sony Vaio} CR 1,6GHz und \textit{HP Compaq} 6710b 2,1GHz zum Einsatz. Um möglichst realistische Bedingungen zu schaffen, wurden die Rechner auf verschiedene Art und Weise an das Internet angebunden. Zwei Laptops nutzten ein 54Mbit WLAN mit VPN Anschluss, ein Laptop befand sich hinter einem NAT-Router mit WLAN, die stationären Rechner verfügten über einen direkten 100Mbit LAN Anschluss. In den Tests nutzten alle Rechner den Breitbandanschluss der Universität Mannheim, der über 33 MBit Down- und 16 MBit Upload verfügt. 

Auf den folgenden Seiten soll nun die Umsetzung, der in Kapitel 3 erarbeiteten Konzepte und Verbesserungsvorschläge erläutert werden. Es werden ausgewählte Probleme und Lösungswege beschrieben, die in dieser Phase der Arbeit aufgetreten sind. 

\subsection{3D-Spielewelt mit Irrlicht}

\subsubsection{Initialisierung}
Zu Beginn des Spieles werden die \textit{Irrlicht} und VoIP-Instanzen initialisiert, die später in zwei verschiedenen Prozessen parallel ablaufen und miteinander zusammenarbeiten. In \textit{Irrlicht} wird die 3D-Welt gerendert und die Darstellung und Steuerung des Avatars vorgenommen und in der VoIP-Instanz wird die Audiokommunikation signalisiert und das Audiosignal abgemischt. 

\subsubsection{Level}
\begin{figure}[tbh]
	\centering
		\includegraphics[width=1.00\textwidth]{grafiken/spielewelt-screenshot.eps}
	\caption{Realistische 3D-Spielewelt mit Radar}
	\label{fig:spielewelt-screenshot}
\end{figure}

Für eine möglichst realistische Umsetzung einer 3D-Welt wurde ein Level benutzt, das einen Park zeigt, in dem Spieler die Möglichkeit haben sich frei zu bewegen. Die Vorstellung, dass Menschen hier spontane Gesprächen führen liegt nahe. Ebenso erscheint in diesem Szenario die Übertragung der Sprache per Luft sehr natürlich. 
Mit Irrlicht wird auch eine einfache \textit{Collision Detection} und Simulation der Schwerkraft vorgenommen, um realistische Verhältnisse zu erzeugen.   

%//AVATARE MD2 Modelle
%//Level Park in Montreal
%\subsubsection{\textit{Collision Detection}}
%Der Spieler kann in der Implementierung mit andern Spielern des Levels und dem Level selbst interagieren. Dabei ist es wichtig, dass eine Berechnung der Kollision des Spielers mit dem Level oder anderen Spielern stattfindet, da ohne eine solche der Spieler alle Gegenstände durchdringen könnte und das Szenario unnatürlich erscheint. Diese Berechnung wird "`\textit{Collision Detection}"' genannt und wird ebenfalls mit im \textit{Irrlicht} Framework umgesetzt. 

\subsubsection{Steuerung}
Der Spieler ist in der Lage sich in alle Richtungen zu Bewegen und zu springen. Dies erlaubt es ihm sich anderen Spielern zu nähern, um mit ihnen in Kommunikation zu treten. Bis auf die Steuerung des Avatars sind keine weiteren Tastenkombinationen nötig, um eine Sprachkommunikation einzuleiten. Diese findet automatisch statt, wenn der Spieler die entsprechende Distanz zum anderen Spieler unterschritten hat. Dies wird in einem Radar, das die verschiedenen Verbindungsstufen abbildet oben rechts auf dem Bildschirm angezeigt. Eine Liste unten links zeigt zusätzlich alle Teilnehmer des Spiels und die Teilnehmer der persönlichen Konferenz an. 

\subsubsection{Radar}

In einem runden Radar am oberen-rechten Bildschirmrand werden alle Teilnehmer des Spiels in Abhängigkeit ihrer Position zum Spieler angezeigt. Spieler werden mit einem Icon und ihrem zugehörigen Namen angezeigt. Das Radar verfügt über drei Zonen, die die einzelnen Verbindungsstufen repräsentieren.  In der öffentlichen Zone wird das Icon gräulich dargestellt, betreten sie die soziale Zone, wird dieser grün gefärbt und in der privaten Zone ist ihr Icon gelb. Die Metapher der Luftübertragung, gepaart mit dem Radar als Orientierungshilfe, unterstützt den Spieler bei der Adressierung von anderen Teilnehmern. Spieler sind direkt in der Lage zu sehen, an wen ihre Sprachnachrichten übertragen werden und welche Teilnehmer sie gerade hören. 

\subsubsection{Lokale Audioszene}
Das Level wurde zusätzlich mit mehreren lokalen Audioquellen ausgestattet, die eine realistische Audioumgebung simulieren. So sind der Wind, Springbrunnen und die Fahrzeuge des Levels mit entsprechenden Audiodateien unterlegt, die mit Hilfe der Irrklang-Engine für das Ohr dreidimensional positioniert werden. Sie helfen die 
Metapher der Luftübertragung von Schall zu unterstützen, da ihre Lautstärke auch mit zunehmender Entfernung abnimmt. Die Audioszene wird lokal erzeugt und muss im Gegensatz zur Sprachkommunikation nicht über das Netzwerk übertragen werden. Die Sprachkommunikation und die lokale Audioszene existieren simultan und erzeugen so für den Spieler eine realistische Illusion. 

\subsection{VoIP-Instanz mit PjSIP}

Die VoIP-Instanz unterscheidet zwischen der Signalisierung und Kontrolle (PJSIP) und dem Fluss des Audiostroms (PJMEDIA). Die Steuerung kann durch eine \textit{Low-level-API} (PJSIP \& PJMEDIA), als auch durch eine \textit{High-level-API} (PJSUA) geschehen. Die gleichzeitige direkte Nutzung der PJMEDIA- und PJSIP-Komponenten bietet eine direkte Kontrolle über jeden Schritt der Anwendung. Im Prototypen wird die PJSUA-API eingesetzt, da sie es erlaubt die Signalisierung, Account-Management, Buddy-Management, Präsenz, Instant-Messeging, Konferenzen und Medien-Funktionalitäten zu abstrahieren, aber trotzdem noch die benötigte Kontrolle über alle Audioströme liefert. 

\subsubsection{Medienfluss}
\begin{figure}
	\centering
		\includegraphics[width=1.00\textwidth]{grafiken/pjsip-mediaflow.eps}
	\caption{Eine Übersicht über den Audiofluss in PjSIP}
	\label{fig:pjsip-mediaflow}
\end{figure}

Die Abläufe, die im Hintergrund ausgeführt werden, sollen kurz erläutert werden: Während der Initialisierungsphase erstellt die VoIP-Instanz einen logischen Sound\-karten-Port und die Conference-Bridge. Diese zwei Objekte bleiben während der Lebenszeit der Applikation erhalten. Wird ein Anruf getätigt oder entgegengenommen, erstellt die Anwendung eine Instanz des Media-Transports (normalerweise UDP). Die Adresse (Port) des Media-Transports wird als Parameter der SDP-IVITE-Nachricht übergeben (empfangen). Ist eine Verbindung etabliert, wird eine Medien-Sitzung erstellt. Der Audiostrom der Medien-Sitzung kann nun genutzt werden und bei der Conference-Bridge registriert werden. Danach kann dieser \textit{Audiostrom-Slot} in der Conference-Bridge mit Slots anderer Audioströme verbunden werden. Eine lokale Audioausgabe ist möglich, indem Audiostrom-Slots mit dem sog. "`Zero-Slot"' verbunden werden, der direkt mit der Soundkarte und dem Mikrofon verbunden ist (siehe auch Abschnitt \ref{conference-bridge}).

Die Hauptkomponenten der Abbildung\footnote{Quelle: PjSIP, Seite besucht 22.03.2008, http://trac.pjsip.org/repos/wiki/media-flow} \ref{fig:pjsip-mediaflow}, die diesen Ablauf schematisch darstellt, bestehen aus:
\begin{itemize}
	\item einem Soundkarten-Port, der die Callbacks der Soundkarte in Audioframes übersetzt,
	\item einer Conference-Bridge, die ein Mischen der Audiosignale erlaubt,
	\item einem Medienstrom, der bei einem Anruf erstellt wird,
	\item einem Medientransport, der für die Übertragung des Medienstroms durch RTP/RTCP Pakete zuständig ist.
\end{itemize}

\subsection{Zusammenarbeit von Irrlicht und PjSIP}

\subsubsection{Start des Spiels}
Bevor das eigentliche Spiel stattfindet, registriert die VoIP-Instanz den Spieler bei einem voreingestellten Registrar. Dazu wird seine Anmeldung gemäß dem im Abschnitt \ref{sip-register} vorgestellten Registrierungsprozess vorgenommen. Ist die Registrierung abgeschlossen, ist der Registrar in der Lage diesen Spieler erfolgreich zu lokalisieren. Während der Registrierungsphase wird auch ein öffentlicher STUN-Server kontaktiert, der es dem Spieler erlaubt seine öffentliche IP Adresse und den Typ des eingesetzten Routers herauszufinden. 

\begin{figure}
	\centering
		\includegraphics[width=0.3\textwidth]{grafiken/gamestart-screenshot.eps}
		\caption{Startbildschirm des Spiels}
\end{figure}

Auf dem Startbildschirm findet der Spieler seine bisherigen Freunde vor und kann ihren aktuellen Status ablesen: Diese können entweder \textit{offline}, \textit{online} oder gerade \textit{im Spiel} sein. Für eine Abfrage des Online-Status wird der SIP-Präsenzdienst\footnote{Eine detaillierte Beschreibung der Vorgänge in der SIP-Netzwerkschicht folgt in Kapitel 8.} in der VoIP-Instanz eingesetzt. Möchte der Spieler das Spiel betreten, kann er einen aktiven Spieler anwählen und mit dem Drücken des \textit{Join}-Knopfs am Spiel teilnehmen. Möchte er ein neues Spiel starten, kann er mit dem Betätigen des \textit{Create}-Knopfes ein neues Spiel anlegen. 

\subsubsection{Während des Spiels}
%neues Spiel%
Betritt ein neuer Spieler das Spiel, so wird er von diesem Zeitpunkt ab vom lokalen \textit{Irrlicht-Scene-Manager} verwaltet und in der 3D-Welt als neuer Avatar an einer festgelegten Einstiegskoodrinate erzeugt. Gleichzeitig wird in der VoIP-Instanz die SIP-Adresse eines neuen Teilnehmers in die lokale \textit{Buddyliste} (siehe Abschnitt \ref{buddy-mehrkanalmodell}) des Spielers aufgenommen. 

%irrlicht scene manager und austausch der positionen%
 Der Irrlicht-Scene-Manager ist für eine Verwaltung aller Objekte der Spielewelt verantwortlich. Er verwaltet sowohl die Koordinaten des Spielers und aller lokalen Objekte, als auch die Koordinaten aller anderen im Spiel anwesenden Spieler. Da jeder Spieler in der Lage ist sich frei im Level zu bewegen, muss jede Bewegung an alle anderen Teilnehmern mit Hilfe der SIP-Netzwerkschicht\footnote{Eine detailierte Beschreibung der Übertragung der Spielerkoordinaten mit Hilfe des SIP-Protokolls findet sich in Kapitel 8.} übertragen werden, damit diese in der Lage sind ihre Spielewelt konsistent zu halten. Erhält der Spieler neue Positionsinformationen von anderen Teilnehmern des aktiven Spiels, werden diese im Irrlicht-Scene-Manager aktualisiert. 

%aktualisierung der Positionsinformationen%
Die 3D-Szene wird in einer Schleife von Irrlicht für jedes Frame neu gezeichnet, während eine Aktualisierung der Positionsinformationen der lokalen VoIP-Instanz aus Effizienzgründen nur alle 10 Frames vorgenommen wird. Anhand der übergebenen Koordinaten aller aktiven Spieler, kann die VoIP-Instanz die entsprechenden Distanzvektoren zu diesen berechnen. In Abhängigkeit der Distanz zu Spielern wird deren Lautstärke entsprechend angepasst (siehe Abschnitt \ref{conference-bridge}) und anhand des Proxemikkonzepts (siehe Abschnitt \ref{Zonen-Implementierung}) verschiedene Konnektivitätsstufen aufrecht erhalten. Bevor diese beschrieben werden, muss zunächst das Problem des Verbindungsaufbaus zwischen zwei Spielern erklärt werden. 

\subsubsection{Verbindungsaufbau}
\label{verbindungsaufbau}
Befinden sich zwei Teilnehmer in einer entsprechenden Hörnähe (öffentliche Distanz), wird diese Bedingung ihre VoIP-Instanzen dazu veranlassen eine Verbindung untereinander aufzubauen. Dabei findet der Verbindungsaufbau entsprechend des SIP-Protokolls statt, besitzt jedoch einen signifikanten Unterschied, der im Folgenden erklärt werden soll:

Möchte Teilnehmer A zu Teilnehmer B eine Verbindung herstellen, sendet er eine SIP-Nachricht INVITE an Teilnehmer B. Die Nachricht enthält die Beschreibung der RTP-Session nach dem SDP Protokoll und alle notwendigen Angaben. Teilnehmer B sendet die gleiche Nachricht, da er auch eine Verbindung herstellen möchte.

Falls ein Teilnehmer die INIVTE Nachricht erhält, prüft er ob er gerade eine Verbindung zum anderen Teilnehmer aufbaut, oder bereits eine Verbindung aufgebaut hat. Ist das der Fall, so antwortet er auf den ankommenden Anruf mit der Response-Nachricht \textit{403 Forbidden}. Diese Vorgehenswiese weicht vom SIP-Standard ab und wird im anschließenden Abschnitt behandelt.

Baut Teilnehmer B jedoch noch keine Verbindung zum anderen Teilnehmer auf und ist auch nicht mit ihm verbunden, so funktioniert der Rufaufbau wie gewohnt. Hat ein Teilnehmer die Verbindung akzeptiert, sendet er einen SIP-Response 200 OK, der vom anderen Teilnehmer mit der ACK-Nachricht bestätigt wird. Mit dem Empfang der ACK-Nachricht, ist die logische Verbindung abgeschlossen. Nun kann eine Verbindung nach dem Protokoll RTP verlaufen und es besteht eine Sitzung zwischen den Teilnehmern. 

\subsubsection{Das Problem der doppelten Verbindung}
Da Teilnehmer zwar zentral lokalisiert werden, jedoch unabhängig von einer zentralen Instanz Verbindungen signalisieren können, kann der Fall auftreten, dass beide Teilnehmer zeitgleich eine Verbindung miteinander aufbauen wollen. Dies geschieht immer dann, wenn beide Spieler im Spiel die erforderliche Nähe zueinander erreicht haben. Dann versucht sowohl Teilnehmer A eine Verbindung zu Teilnehmer B, als auch Teilnehmer B eine Verbindung zu Teilnehmer A aufzubauen (siehe Abbildung \ref{fig:sipanruf_403}). Dies entspricht dem Problem im Alltag, wenn zwei Personen versuchen zur exakt gleichen Zeit anzurufen und jeder nur ein Besetztzeichen hört. 

\begin{figure}[tbh]
	\centering
		\includegraphics[width=0.60\textwidth]{grafiken/sipanruf_403.eps}
		\caption{Ablauf einer symmetrischen Verbindung}
	\label{fig:sipanruf_403}
\end{figure}

Bei diesem Szenario können zwei verschiedene Fälle auftreten. Der einfache Fall liegt vor, wenn bei Teilnehmer B eine INVITE-Nachricht von A eintrifft und B bereits mit A verbunden ist. Dann kann er den zweiten Dialog einfach verwerfen, da ja bereits eine bestehende Verbindung existiert.

Der kompliziertere Fall ist der symmetrische Fall: Dieser tritt dann ein, wenn B während er selbst eine Verbindung mit A aufbaut, die INVITE-Nachricht erhält. Hier hat B ebenfalls eine INVITE Nachricht an A geschickt, während A zur gleichen Zeit auch eine INVITE Nachricht an B geschickt hat. Lehnen nun beide Teilnehmer die Verbindung ab, so führt es dazu, dass in diesem Fall überhaupt keine Verbindung zwischen den Teilnehmern zustande kommt. 

Hierbei ist die Existenz einer gemeinsamen Regel für alle Teilnehmer wichtig, nach der sie beim Dialog-Aufbau vorgehen. Die hier gewählte Lösung sieht vor, dass beide Teilnehmer eine zufällige Zeit $t$ warten und danach versuchen eine neue Verbindung zu etablieren bis der unsymmetrische Fall auftritt. Diese Vorgehensweise hat sich in der Praxis bewährt. 

\subsubsection{Verbindungsabbau}
Verlassen die Teilnehmer wieder die Hörnähe (öffentliche Distanz) findet in der der VoIP-Instanz der Verbindungsabbau wie gewohnt statt: Beide Teilnehmer senden eine BYE-Nachricht an den anderen Teilnehmer, die mit einer ACK-Nachricht bestätigt wird. 

\subsubsection{Beenden des Spiels}
Spieler können anhand des SIP-Präsenzdienstes\footnote{Eine detaillierte Beschreibung der Implementierung dieses Dienstes findet sich in Kapitel 8} feststellen, wann ein Spieler das Spiel verlassen hat. Beendet ein Spieler sein Spiel, so bedeutet es für die übrigen Spieler nicht das Ende des kompletten Spiels. Das Verlassen eines Teilnehmers hat nur zur Folge, dass dieser seine Positionsinformationen nicht mehr versendet und auch keine weiteren mehr empfängt. Außerdem werden alle aktiven Gespräche mit diesem Spieler werden beendet. 

\section{Umsetzung des Mehrkanalmodells}
\label{buddy-mehrkanalmodell}
Die Spieler im Spiel werden durch Avatare repräsentiert. Jedem Avatar im Spiel ist ein entsprechender "`Buddy"' in der VoIP-Instanz gegenübergestellt. Diese hält somit eine lokale Liste aller Mitspieler vor. Sämtliche Sprachkommunikation findet durch einen Anruf zum entsprechendem \textit{Buddy} statt. Falls sich mehrere Personen in der Hörnähe des Spielers befinden, werden auch mehrere Anrufe zu den entsprechenden Personen durchgeführt. Da für jeden Teilnehmer ein eigener Anruf getätigt und separat verwaltet wird, ist der Spieler in der Lage die Parameter wie Lautstärke, Bitrate und Codec jedes einzelnen Anrufs zu verändern und neu auszuhandeln. Alle getätigten Anrufe werden in der lokalen \textit{Conference-Bridge} abgemischt. Dieses Verhalten entspricht dem Mehrkanalkonzept aus Kapitel 3. 

\section{Umsetzung der Methapher der Luftübertragung}
\label{umsetzungluftmetapher}
\subsection{Erweitertes Mixing-Konzept}
Wie Kapitel 3 gezeigt hat, ist bisher die Teilnahme an Konferenzen binär gelöst worden, indem Spieler entweder Teil einer solchen waren oder nicht. So ist bisher das in einer Konferenz mit \textit{n} Teilnehmern ${p_{1},p_{2},...,p_{n}}$, mit Audioströmen ${V_{1}(t),V_{2}(t),...,V_{n}(t)}$, von einem Teilnehmer $i$ zu einer Zeit \textit{t} empfangene Signal $R_{i}(t)$ aller Teilnehmer $j$ definiert durch:

\begin{align}
	R_{i}(t) = \sum \limits_{j=1}^n {V_{j}(t)}  \ \ \mbox{wobei} \  j \neq i
\end{align}

Dies bedeutet, dass das empfangene Signal der Summe der Signale aller Teilnehmer entspricht.  Um die Metapher der Luftübertragung zu simulieren, ist es erforderlich den binären Teilnahmestatus durch eine stetige Teilnahmefunktion zu ersetzen.  Die Gesamtlautstärke $R_{i}(t)$ aller empfangenen Audiosignale $V_{j}(t)$ wird von der Distanz $d_{j}$ zum anderen Teilnehmer abhängig gemacht. Dabei wird die Lautstärke der jeweiligen Audioströme mit dem Parameter $d_{j}$ zwischen 0 und 1 gewichtet, bevor diese summiert werden.  Die Parameter $d_{j}$ werden  anhand der Distanz der Avatare vom Spieler errechnet, die auf einen Bereich zwischen 0 und 1 normiert werden. Durch dieses Vorgehen kann die Abnahme der Lautstärke des Signals in Abhängigkeit der Entfernung des Teilnehmers simuliert werden.

\begin{align}
\label{mixingalgo}
	R_{i}(t) = \sum \limits_{j=1}^n {d_{j} \cdot V_{j}(t)} \ \ \mbox{wobei} \ j \neq i
\end{align}

Da die VoIP-Instanz alle 10 Frames von Irrlicht mit neuen Positionsinformationen versorgt wird, werden auch die Distanzvektoren alle 10 Frames neu berechnet und die Lautstärke des entsprechenden Audiostroms anhand diesen angepasst. Auf diese Art und Weise entsteht der gewünschte Effekt, dass Personen die sich in der Nähe befinden sind besser zu hören, als Personen die sich weit entfernt befinden.

\subsection{Erweiterte Conference-Bridge}
\label{conference-bridge}

Das Abmischen der Audioströme bestehender SIP-Anrufe wird von der lokalen \textit{Conference-Bridge} übernommen (siehe Abbildung \ref{fig:conference-bridge}). Jeder Teilnehmer der Conference-Bridge verfügt über einen Eingangs- und Ausgangs-Kanal, die beliebig miteinander verschaltet werden können. Das Mikrofonsignal des Spielers wird unverändert an alle Teilnehmer der Conference-Bridge übertragen. Die empfangenen Signale werden entsprechend der oben vorgestellten Formel \eqref{mixingalgo} in ihrer Lautstärke angepasst. Liegen die Audiosignale in verschiedenen Abtastraten vor, übernimmt die Conference-Bridge automatisch ein \textit{Resampling} des Signals.

\begin{figure}
	\centering
		\includegraphics[width=1.00\textwidth]{grafiken/conference-bridge.eps}
	\caption{Funktionsweise der Konferenzbrücke mit 5 Teilnehmern und Anpassung der einzelnen Audioströme}
	\label{fig:conference-bridge}
\end{figure}

Wie bereits in Kapitel 3 gefordert, wird nur in der sozialen Zone des Spielers ein solches Abmischen vorgenommen. In der privaten Zone werden die Audioströme mit ihrer Maximallautstärke summiert. Überschreiten Spieler im Spiel die maximale Distanz der sozialen Zone, werden die Teilnehmer aus der Konferenzbrücke entfernt und nicht mehr abgemischt. Der logische SIP Anruf jedoch so lange erhalten, bis sie auch die öffentliche Zone verlassen haben. Dieses Verhalten wird im darauf folgenden Abschnitt beschreiben. 

\section{Umsetzung des Proxemikkonzepts}
\label{Zonen-Implementierung}
Die Umgebung des Spielers wurde entsprechend dem Entwurf in Kapitel 3 in drei Zonen unterteilt. Wie auch Kapitel 6 gezeigt hat, kann durch die Etablierung verschiedener Konnektivitätsstufen Bandbreite eingespart werden. Der Wechsel der einzelnen Zonen in Abhängigkeit von der Distanz der Teilnehmer wird in Abbildung \ref{fig:zonenkonzept} dargestellt. Die Umsetzung dieses Konzepts und Beschreibung technischer Verfahren, wie Bandbreite eingespart werden kann soll nun erläutert werden:

\begin{figure}[htbp]
	\centering
		\includegraphics[width=\textwidth]{grafiken/zonenkonzept2.eps}
	\caption{Zonenkonzept und daraus resultierende Funktionalität}
	\label{fig:zonenkonzept}
\end{figure}

\subsection{Öffentliche Zone}
Die öffentliche Zone wird genutzt, um SIP-Verbindungen des Spielers mit anderen Teilnehmern zu initiieren und so eine Grundkonnektivität zwischen diesen herzustellen, da es wahrscheinlich ist, dass Spieler die bereits diese Entfernung eingenommen haben, auch die soziale Zone betreten werden, in der tatsächlich eine Audioverbindung stattfindet. Da der SIP-Verbindungsaufbau recht komplex ist (siehe Abschnitt \ref{rufaufbau}) und mitunter bis zu 1 oder 2 Sekunden betragen kann, wird diese Zone dazu genutzt, um vorab die gesamte Signalisierung vorzunehmen. Dabei soll die etablierte Grundkonnektivität eine minimale Bandbreite beanspruchen, aber einen raschen Aufbau der Audiokommunikation in der sozialen Zone gewährleisten damit eine Sprachkommunikation in der sozialen Zone verzögerungsfrei stattfinden kann. 

Die öffentliche Zone kann aus zwei "`Richtungen"' betreten werden. Wird sie von außen (Kein Anruf) betreten, wird eine logische SIP Verbindung zwischen den Teilnehmern aufgebaut. Der doppelte Verbindungsaufbau und die entstehenden Probleme wurden bereits in Abschnitt \ref{verbindungsaufbau} beschrieben. Wird sie von innen (soziale Zone) betreten, wird der Teilnehmer aus der Confrence-Bridge entfernt. Befindet sich der Teilnehmer erst einmal in der öffentlichen Zone, wird eine Reduzierung des Bandbreitenverbrauchs vorgenommen, während die logische SIP-Verbindung aufrecht erhalten wird. Bei der Umsetzung wurden zwei Mechanismen ausprobiert, die die speziellen Eigenschaften der verwendeten SIP und RTP-Protokolle nutzten, um dies zu bewerkstelligen.

\subsubsection{RTP - Silence Supression}
Während der logische SIP Anruf weiterhin erhalten bleibt, wird auf auf RTP Ebene kein weiteres Audiosignal mehr übertragen. Dies geschieht, indem die Teilnehmer jeweils aus der lokalen Konferenz entfernt werden und so das jeweilige Mikrofonsignal nicht mehr übermittelt wird. 

Da kein Audiosignal mehr an die gegenseitigen Spieler übertragen wird, wird von nun vom VAD-Algorithmus (Voice-Activity-Detection) eine \textit{Silence Suppression} vorgenommen. Dieses Verhalten entspricht der im Kapitel 3 geschilderten Eigenschaften der Silence Supression des RTP-Protokolls. Der Unterschied besteht hier darin, dass die Silence Supression nicht von der tatsächlichen Stille im Mikrofon abhängt, sondern von der Entfernung der Teilnehmer untereinander. 

Diese Methode bietet die Möglichkeit, den Bandbreitenverbrauch in dieser Zone auf unter 1 KByte/s \footnote{Messungen zum Bandbreitenverbrauchs in dieser Zone finden sich in Kapitel 9.} zu reduzieren. Der große Vorteil dieses Verfahrens besteht darin, dass der Wechsel zwischen der öffentlichen und sozialen Zone verzögerungsfrei stattfinden kann, da kein neues Aushandeln der Parameter benötigt wird.

\subsubsection{SIP-Hold-Funktion}
Eine Reduzierung des Bandbreitenverbrauch wurde auch mit der SIP-Hold Funktionalität ausprobiert. Hierbei signalisiert das SIP-Protokoll, dass der Anruf "`geparkt"' werden soll und die RTP-Verbindung während des Hold-Vorgangs beendet wird. Wird der Hold-Vorgang aufgehoben, wird die RTP-Verbindung wieder neu etabliert. Die Messergebnisse\footnote{siehe Anhang} und eigene Erfahrungen haben gezeigt, dass zwar eine noch größere Einsparung der Bandbreite, als bei der RTP-Silence-Supression stattfindet, da praktisch keine Daten mehr übertragen werden. Der Nachteil besteht jedoch darin, dass beim Wiederaufnehmen des Anrufs eine spürbare Verzögerung auftritt, da die Verbindungsparameter des Gesprächs wieder neu verhandelt werden müssen. Diese Gründe führten dazu die SIP-Hold-Funktion nicht einzusetzen und stattdessen die Silence Suppression zu bevorzugen. 

\begin{figure}[tbh]
	\centering
		\includegraphics[width=0.60\textwidth]{grafiken/siphold.eps}
	\caption{Schematischer Ablauf des SIP-HOLD Nachrichtenverlaufs}
	\label{fig:siphold}
\end{figure}

\subsection{Soziale Zone}
In der sozialen Zone werden die Teilnehmer mit denen bereits Verbindungen aufgebaut wurden, nun der eigenen lokalen Konferenz hinzugefügt. Innerhalb dieser Konferenz wird die Lautstärke der Teilnehmer gemäß ihrer Entfernung angepasst. Audiosignale von Teilnehmern, die sich am inneren Rand der sozialen Zone des Spielers befinden werden ungedämpft mit einer Lautstärke von 100\% abgemischt. Diese nimmt linear in Abhängigkeit der Entfernung zu den Spielern ab, bis sie am äußersten Rand der Zone 0\% beträgt. Dies Entspricht der Methapher der Luftübertragung, die in dieser Zone ihre Anwendung findet und bereits in Abschnitt \ref{umsetzungluftmetapher} behandelt wurde.

%\subsubsection{Lautstärkenanpassung}
%Da die Lautstärke der übertragenen Stimme bei einer Übertragung durch Luft mit zunehmender Entfernung abnimmt wurde ein einfaches physikalisches Modell der Schallübertragung benutzt: Generell gilt, dass Schalldruck bei zunehmender Entfernung $r$  mit $1/r$ abnimmt. Da sich die Schallintensität auf eine immer größer werdende gedachte Kugeloberfläche (proportional zur Entfernung $r$) verteilt, nimmt sie mit der Entfernung quadratisch ab. 

Zu Testzwecken wurden sowohl die lineare als auch die quadratische Abnahme der Schallintensität\footnote{Schalldruck nimmt bei zunehmender Entfernung $d$ mit $1/d$ ab. Da sich die Schallintensität auf eine immer größer werdende gedachte Kugeloberfläche (proportional zur Entfernung $d$) verteilt, nimmt sie mit der Entfernung quadratisch ab.} modelliert, um festzustellen welche Veränderung natürlicher erscheint. Die lineare Abnahme erwies sich als transparenter für den Benutzer, da eine einfachere Relation zwischen Lautstärke und Entfernung hergestellt werden konnte. 

Als ein Problem bei der Lautstärkenanpassung erwies sich die unterschiedliche Aufnahmelautstärke der Mikrofone. Da verschiedene Mikrofone eine unterschiedliche Sensibilität haben, senden Spieler unter Umständen bei gleicher Entfernung verschieden laute Signale. In einem fertigen Produkt, sollte das Mikrofon dynamisch auf einen bestimmten Pegel normiert werden, bevor das Spiel beginnt. Solche Verfahren sind Standard bei VoIP-Telefonen und könnten später auch hier eingesetzt werden. %http://www.sengpielaudio.com/Rechner-entfernung.htm

\subsubsection{Audiocodec}
In der sozialen Zone wird ein Audiocodec mit einer niedrigen Bitrate eingesetzt, um eine größere Anzahl an möglichen Mitspielern zu ermöglichen. In den Testszenarios in Kapitel 9 wurde der Speex Audiocodec mit einer Abtastrate von 16kHz und einer Bitrate von 16.8 Kbit/s eingesetzt, der einen MOS-Wert von über 4 liefert. Es ist natürlich vorstellbar auch qualitativ schlechtere Codecs mit einer noch geringeren Bitrate einzusetzen, um dem Spieler noch mehr Verbindungen zu ermöglichen. Diese Entscheidung kann in einem fertigen Produkt entweder dem Spieler selbst - bei einer manuellen Konfiguration - überlassen werden oder automatisch anhand der verfügbaren Bandbreite bestimmt werden. So könnten Spieler mit einer höheren Bandbreite auch ein besseres Audiosignal verbreiten, während Spieler mit einer schwachen Anbindung nur Codecs mit einer niedrigen Bitrate einsetzen könnten.

\subsection{Private Zone}

\subsubsection{Lautstärke}
In der privaten Zone A bleibt die Laut\-stärke der Teilnehmer konstant bei 100\%. Dies ermöglicht den Teilnehmern sich in einem kleinen Radius umeinander zu bewegen, und trotzdem immer noch mit einer optimalen Lautstärke zu kommunizieren. 

Entsprechend der Vorschläge aus Kapitel 6 wurden in der privaten Zone eine Unterscheidung vorgenommen, indem ein qualitativ höherwertiger Codec mit einer größeren Bitrate und einem größeren MOS Wert verwendet wird. Diese Vorgehensweise soll dafür sorgen, das Mitspieler in unmittelbarer Nähe besonders gut verständlich sind. Im Gegensatz zur sozialen Zone wird erwartet, dass nur wenige Spieler diese Zone betreten, da angelehnt an die Erkentnisse aus Kapitel 2 Menschen in virtuellen Welten ähnliche Distanzzonen einnehmen, wie im realen Leben. In der Implementierung wurde in einem Testszenario (siehe Evaluation Kapitel 9) für die private Zone der Speex Codec mit einer Abtastrate von 16 kHz verwendet, während in der Sozialen Zone der Speex Codec mit einer geringen Abtastrate von 8 kHz eingesetzt wurde. 

\section{PTSN-Netzwerke}
Durch die Möglichkeit SIP-Server mit externen Gateways zu verbinden, wurde auch die Metapher des Festnetz-Telefons umgesetzt, die dem Spieler tatsächlich erlaubt aus der virtuellen Welt in die reale Welt zu telefonieren. Dazu wurde das Modell einer Telefonzelle auf dem Spielfeld platziert. Befindet sich der Spieler in Hörnähe zu dieser Telefonzelle, findet ein Anruf an eine beliebige Telefonnummer statt. Dieser \textit{Proof of Concept} zeigt, dass mit Hilfe eines standardisierten Protokolls solche Möglichkeiten sehr einfach realisiert werden können. 
\cleardoublepage