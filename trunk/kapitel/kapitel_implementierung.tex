\chapter{Implementierung}

Dieses Kapitel befasst sich mit der Implementierung des Spiel-Prototyps mit distanzbasierter integrierter Sprachkommunikation auf Basis eines hybriden SIP Multi-unicast-Ansatzes und präsentiert ausgewählte Details und Probleme bei der Umsetzung. Hauptaugenmerk liegt dabei auf der technischen Umsetzung der in \textit{Kapitel3} vorgestellten distanzbasierten Sprachkommunikation, dem Einfluss der Zonenkonzepte auf die verwendete Bandbreite, und der Zusammenarbeit der 3D-Welt mit der VoIP-Anwendung.

 \section{Art des Spieleprototyps}
 \label{prototyp}
Mehrspieler-Computerspiele spielen in detaillierten, realistischen virtuellen 3D-Welten, durch die man mittels einer Spielfigur navigiert. In diesen Welten kommunizieren Spieler miteinander aus verschiedenen Gründen wie z.B. um die Strategie zu besprechen, Hilfe zu rufen, die Leistung des Anderen zu bewerten oder um einfach nur zu plaudern. 

Eine klassische Unterteilung \cite{aarseth03} von Spielen in Spielegenres zeigt, dass in 
Abhängigkeit vom Genre des Spiels der Kommunikationsaspekt unterschiedlich stark ausgeprägt ist. Vor allem 3D-Actionspiele und Echtzeit-Rollenspiele haben den größten Bedarf an einer ausgeprägten Sprachkommunikation, da sie den Echtzeit-Aspekt betonen und oft eine kollektive synchronisierte Zusammenarbeit mehrerer Spielergruppen benötigen. 

Auch der Prototyp des Spiels soll eine virtuelle, detaillierte und realistische 3D-Welt abbilden, in der der Spieler die Möglichkeit frei bewegen und mit anderen Spielern in Interaktion treten kann.

Im Viereck \cite{lindley03}, \cite{gibbs05} aus Spielerlebnis, Spielsimulation, erzählerischem Aspekt und der Spielerinteraktion soll hier eine hohe Spielerinteraktion und Simulationstiefe erreicht werden. Ein Antibeispiel wäre ein Spiel wie Tetris das zwar ein ausgeprägtes Spielerlebnis besitzt aber nur geringfügig in der Spielesimulation erzählerischem Aspekt ausgebildet ist und über keine Spielerinteraktion verfügt. Ein gutes Beispiel wäre das Mehrspieler-Computerspiel \textit{Second Life} das einen hohen Grad an Spielerinteraktion besitzt, dafür aber in anderen Dimensionen kaum ausgeprägt ist. 

Obwohl in dieser Arbeit kein Anspruch darauf besteht einen Prototypen zu entwickeln, der einem ausgereiften 3D-Action- oder Echtzeit-Rollenspiel entspricht, besteht ein Ziel der Arbeit darin, den Aspekt der gemeinsamen Spielerinteraktion zu betonen. Dies soll vor allem durch eine möglichst effektive und intuitive Einsatzmöglichkeit der Sprachkommunikation erreicht werden, während sich der Spieler in einer möglichst realistischen Umgebung befinden soll.
 
\begin{figure}[tbh]
	\centering
	\includegraphics[width=1.00\textwidth]{grafiken/spielgenredreieck.eps}
	\caption{Viereck aus Spielerlebnis, Simulation, erzählerischem Aspekt und Spielerinteraktion}
	\label{fig:spieledreieck}
\end{figure}


 \section{3D-Umgebung}
Da die Entwicklung eines realistischen Spieles weit über das Thema der Arbeit hinausgeht und diese Aufgabe normalerweise von ganzen Teams über mehrere Monate oder Jahre bewältigt wird, sollen nach Möglichkeit bestehende Komponenten eingesetzt werden.

Hierzu existieren bereits Frameworks, die dazu eingesetzt werden können einen Prototypen zu erstellen, in dem ein Avatar in einer möglichst realistischen 3D Umgebung gesteuert werden kann. 

Viele der bestehenden Frameworks für 3D orientierte Spiele basieren meist auf den Eigenenwicklungen großer Softwarestudios wie \textit{Idsoftware}\footnote{IdSoftware, Version 21.03.2008, http://www.idsoftware.com/} oder \textit{Epic Games}\footnote{Epic Games, Version 21.03.2008, http://www.unrealtechnology.com}. Diese setzten Standards, indem sie den Quellcode ihrer bisher erfolgreichsten Spiele wie z.B.\textit{Quake II}, \textit{Quake III} oder \textit{Unreal I} öffentlich anboten. Da meist mit dem Aufkommen einer neuen Generation kommerzieller Titel die Entwicklung eines neuen Frameworks mit einher geht, existieren von den Haupvertretern großer Frameworks gleich mehrere Versionen und Derrivate\footnote{Wikipedia, Version: 21.03.2008,  http://en.wikipedia.org/wiki/Quake\_series}. 

Seit einigen Jahren sind auch komplette Neuentwicklungen wie \textit{Sauerbraten}\footnote{W. Oortmerssen, Version 21.03.2008, http://sauerbraten.org} oder \textit{Nexuiz}\footnote{Alientrap, Version 21.03.2008, http://www.alientrap.org/nexuiz/} speziell für 3D-Actionspiele geschrieben worden. Obwohl diese eine opulente Grafik, ausgereifte Spielbalance und durchdachte Steuerung bieten, ist die Modifikation der darunter liegenden Hauptbestandteile schwer. Technische Details der Netzwerk- und Audiokomponenten oder der eigentlichen Spielelogik sind teilweise nicht ausführlich dokumentiert und machen Änderungen sehr mühsam oder sehen diese gar nicht vor. 

\subsection{3D-Engines}
Eine Alternative zu reinen Spiele-Engines bieten offene generische 3D-Engines, deren Fokus nicht auf der kompletten Entwicklung eines speziellen Spiels liegt. Stattdessen sollen sie möglichst komfortabel die Darstellung von 3D-Grafiken ermöglichen. Dazu werden meist die Details von Systembibliotheken wie \textit{Direct3D} oder \textit{OpenGL} abstrahiert und dem Entwickler ein Interface angeboten, das auf höheren Abstraktionsklassen basiert. Bekannte Vertreter sind \textit{Ogre3D}\footnote{TheOGRETeam, Version. 22.03.2008,  http://www.ogre3d.org/} oder \textit{Irrlicht}\footnote{N. Gebhardt, Version. 22.03.2008, http://irrlicht.sourceforge.net/}. 

\subsubsection{\textit{Irrlicht}}
\textit{Irrlicht} ist ein einfaches gut dokumentiertes Open-Source Framework das in C++ geschrieben wurde. Alle üblichen 3D Features wie \textit{Collision Detection}, Animationen, \textit{Shading} und Texturen werden sowohl unter \textit{Windows}, \textit{Linux} als auch \textit{Mac OS} unterstützt. Aufgrund der bestehenden Arbeit von Triebel \cite{triebel07g}, war es möglich, bereits bestehende Konzepte zu verwenden und somit eine schnelle Entwicklung des Prototyps zu gewährleisten.

\subsubsection{\textit{Irrklang}}
Speziell für die Sprachkommunikation musste das 3D-Framework um eine Audio-Engine erweitert werden, die eine gezielte Audioausgabe ermöglicht. Speziell für Irrlicht existiert \textit{IrrKlang}\footnote{Nikolaus Gebhardt, Version 15.04.2008, http://www.ambiera.com/irrklang}, eine einfache Plattform-übergreifende Audiobibliothek. Sie unterstützt Audioverarbeitung auf der nativen Ebene, realistisches \textit{3D-Audio-Rendering}, \textit{Multithreading} und kann über \textit{Plugins} erweitert werden. Zusätzlich verfügt sie über eine einfache API, die eine schnelle Einarbeitung und Entwicklung ermöglicht. All diese Gründe waren ausschlaggebend, diese Bibliothek zu benutzen. 

\section{VoIP-Lösungen}

Zwecks der Implementierung einer Sprachkommunikationslösung stehen mehrere Alternativen zur Verfügung: 

\begin{itemize}
	\item Bestehende Drittanbieter Lösungen können abgeändert werden, um den gestellten Ansprüchen zu genügen.
	\item Existierende VoIP Programme können durch Nutzung ihrer API genutzt werden, um während dem Spiel Audioinformationen zu übertragen.
	\item Bibliotheken oder \textit{Protokollstapel}, können genutzt werden um eigene VoIP Lösungen zu entwickeln.
\end{itemize}

Bisher werden im Spielebereich fast ausschließlich serverbasierte Drittanbieter Lösungen eingesetzt. Sie alle bieten Unterstützung für effiziente Audiocodecs und besitzen einen vergleichbaren Funktionsumfang. Im privaten VoIP Telefoniebereich werden oft kommerzielle Produkte wie \textit{Skype} eingesetzt. Es existieren kaum offene Sprachkommunikationslösungen. Gleichzeitig existieren viele bestehende offene Protokollstapel, mit denen eigene Lösungen implementiert werden können.

\subsection{Serverbasierte Sprachkommunikationslösungen}
%http://www.tentonhammer.com/index.php?q=node/102

\subsubsection{Ventrillo, Teamspeak und Mumble}
%http://www.ventrilo.com/
Die unter Spielern beliebtesten Lösungen sind 
\begin{itemize}
	\item \textit{Ventrillo}\footnote{Flagship Industries Inc., Programmversion 3.0.1, http://www.ventrilo.com}
	\item \textit{Teamspeak}\footnote{TeamSpeak Systems GmbH, Programmversion 2.0.33.7, http://www.goteamspeak.com} 
	\item \textit{Mumble}\footnote{Thorvald Natvig, Programmversion 1.1.3, http://mumble.sourceforge.net}
\end{itemize}
 
 Bei allen der drei Produkten handelt es sich um serverbasierte VoIP-Anwendungen. Die Software besteht aus einem Server- und Client-Modul, wobei die Clientsoftware frei erhältlich ist, für die Serverkomponente jedoch ab einer größeren Anzahl\footnote{Der TeamSpeak Endbenutzer-Lizenzvertrag erlaubt es eigene kostenlose private Server aufzusetzen, falls eine Maximalanzahl an Serverinstanzen und Spielern nicht überschritten wird.} an Spielern eine kostenpflichtige Lizenz zu erwerben ist. 
 
 Benutzer des Clients melden sich vor Beginn des eigentlichen Spieles auf einem Server an und können dort einen Kanal betreten. Benutzer des gleichen Kanals auf dem gleichen Server können sich gegenseitig hören. Zusätzlich existieren Plugins, die es erlauben Kanäle während der Spielesitzung per Tastaturkombination zu wechseln. Vor allem durch die hohen Bandbreitenanforderungen müssen Konferenzserver oft auf dedizierten kostenpflichtigen Maschinen untergebracht werden. Die Lizenz solcher Anwendungen erlaubt es auch nicht die Software nach eigenen Vorstellungen anzupassen. 

Einzig \textit{Mumble} ist eine offene VoIP Anwendung. Ihre Verwendung gleicht den anderen bisher vorgestellten Programmen. Der einzige Unterschied liegt in der Betonung der sozialen Komponente der Sprachkommunikation. Durch sehr wenige administrative Elemente eine hohe Sprachqualität, soll die Kommunikation zwischen Spielern besonders einfach und gut verständlich sein.

Obwohl die kommerziellen Lösungen bei einer optimalen Konfiguration Hunderte von Benutzern unterstützen können und eine gute Sprachqualität bieten, haben sie den entscheidenden Nachteil, dass deren Lizenz eine Änderung der Client- und Serverkomponenten nicht vorsieht, was deren Nutzung für eine Umsetzung des Prototypen nicht brauchbar macht. 

\textit{Mumble} ist zwar dank seiner freien Lizenz als einziges modifizierbar, jedoch aufgrund der komplizierten Serverkonfiguration und einem komplexen Rechtesystem, das auf Gruppen und Regeln basiert, nicht einfach an die neuen Konzepte anzupassen. Zusätzlich zu den vorhandenen Problemen sind die drei Lösungen untereinander nicht kompatibel und bieten somit nur Insellösungen. 

\subsection{Dezentralisierte Sprachkommunikationslösungen}

Es existieren etliche verschiedene VoIP Programmen, die alle als dezentralisierte Lösungen eingesetzt werden können. Eine tatsächlich dezentrale Architektur kann jedoch bisher nur \textit{Skype} bieten. 

\subsubsection{Skype}

Das Programm \textit{Skype} des Unternehmens Skype Technologies\footnote{Skype Technologies, Version 23.03.2008, http://www.skype.com} bietet innerhalb des eigenen Netzwerkes von registrierten Skype Benutzern die Möglichkeit des Instant Messaging, des Dateitransfers und der kostenlosen Telefonie über das Internet.
Von den Mitbegründern der Tauschbörse \textit{Kazaa}\footnote{Internet Tauschbörse (Sharman Networks Ltd), Version 23.03.2008, http://www.kazaa.com} ins Leben gerufen, basiert Skype wie das Filesharingprogramm auf dem Peer-to-Peer Prinzip. Die Vermittlung, die Gespräche und auch Dienste wie das Teilnehmerverzeichnis werden nicht von einem zentralen Server angeboten, sondern auf alle gleichberechtigten Teilnehmer (den so genannten Peers) verteilt. Lediglich für die Authentifizierung und die Abrechnung bedient sich Skype eines zentralen Back-End-Servers. Das Skype Netzwerk unterscheidet zwischen einfachen Benutzern (Ordinary Hosts genannt) und den Super Nodes. 

Super Nodes sind Ordinary Hosts mit einer öffentlichen IP-Adresse und ausreichender Bandbreite, CPU-Leistung und Hauptspeicher und dienen als Endpunkte für die anderen
Hosts. Der Benutzer selber hat keinen Einfluss auf die Entscheidung, ob sein Rechner als Super Node fungiert oder nicht. In diesem Zusammenhang kann man bei Skype nicht von einer reinen P2P Architektur sprechen, da nicht alle beteiligten Rechner gleiche Aufgaben übernehmen. 

Die \textit{Skype} Technologie ermöglicht als einziges ein völlig dezentrales VoIP. Der Einsatz des \textit{Skype} Dienstes und Clients ist kostenlos. Über das \textit{Skype-API }ist es auch für externe Programme möglich, auf die Funktionalitäten des \textit{Skype-Clients} zu nutzen.

Trotz dieser Vorteile bietet \textit{Skype} auch einige Nachteile: Über die Technik, die von der Skype Anwendung verwendet wird, ist nicht viel bekannt, da die gesamte Kommunikation per AES mit 256 Bit verschlüsselt wird, somit nicht zu analysieren ist und das Protokoll eine proprietäre Entwicklung von Skype Technologies ist. Somit kann das Protokoll nur mit der Originalsoftware genutzt werden. In der kostenlosen Version sind nur Konferenzen mit bis zu 5 gleichzeitigen Teilnehmern möglich. Auch in einer kostenpflichtigen Version werden nur bis zu 10 gleichzeitige Konferenzteilnehmer unterstützt. 

Beide Versionen jedoch bieten auf Clientseite keine Kontrolle über die einzelnen Audioströme. So kann nur die Summe aller Audioströme empfangen werden. Die Clientanwendung ist nicht in der Lage, einzelne Audioströme auszublenden oder die Lautstärke einzelner Teilnehmer zu ändern. Zudem bietet die \textit{Skype API} nur zwei spezielle Interfaces an, um entweder Anrufe zu tätigen oder Nachrichten zu verschicken. Eine Architektur für weitere Dienste ist nicht vorgesehen \cite{schulzrinne05}.

Somit bietet \textit{Skype} als einziger tatsächlicher dezentralisierter Client nicht alle Eigenschaften, um als mögliche Ausgangsgrundlage zu dienen. 

\subsection{Instant Messaging Anwendungen}
Andere Peer-to-Peer Programme wie \textit{Microsoft-Netmeeting}\footnote{Microsoft, Version 20.03.2008, http://de.wikipedia.org/wiki/NetMeeting}, \textit{Microsoft-Messenger}\footnote{Microsoft, Version 20.03.2008, http://messenger.live.com} oder \textit{Google Talk}\footnote{Google, Version 20.03.2008, http://www.google.com/talk} sind nicht modifizierbar und bieten nur sehr eingeschränkte Konferenzmöglichkeiten. 

\subsection{SIP-Protokoll}
Das im Kapitel 4 vorgestellte SIP Protokoll und existierende Protokollstapel erfüllen die gestellten Anforderungen an den Prototypen. Da SIP ein generisches und offenes Protokoll ist, kann es benutzt werden, um beliebige Sitzungen mit einem oder mehreren Teilnehmern zu verwalten. Dabei ist es nicht auf Internet-Telefonie beschränkt, sondern kann Sitzungen zwischen beliebigen Multimediaströmen, Konferenzen oder Computerspielen herstellen. Zahlreiche Standard\-isier\-ungs-Organisationen wie \textit{IETF\footnote{IETF, Version 22.03.2008, http://www.ietf.org/html.charters/sip-charter.html}, 3GPP\footnote{3GPP,Version 22.03.2008, http://www.3gpp.org/}, International Packet Communications Consortium\footnote{IPCC,Version 22.03.2008, http://www.imsforum.org/}, IMTC\footnote{ITMC, Version 22.03.2008, http://www.imtc.org/} und PacketCable\footnote{PacketCable, Version 22.03.2008, http://www.packetcable.com/}} unterstützen bereits den Einsatz von SIP.
%http://www.cs.columbia.edu/sip/

In der Open-Source Gemeinde wird das SIP-Protokoll auch zunehmend unterstützt. So existieren bereits etliche Clientanwendungen und zentrale Komponenten wie \textit{Proxys} und \textit{Registrare}. Darüber hinaus finden sich zahlreiche gut dokumentierte SIP-Protokollstapel und \textit{SDKs}. Es existieren auch Referenzimplementierungen, wie \textit{JAIN-SIP} \footnote{Sun Microsystems, Version 24.03.2008, http://jain-sip.dev.java.net}, die sowohl in kommerziellen Projekten aber auch zu Forschungszwecken eingesetzt werden. Der wichtigste Grund für den Einsatz von SIP ist, dass es alle Anforderungen für die Umsetzung des Prototyps unterstützt:

\begin{itemize}
	\item Offener Standard
	\item Generisches Protokoll um Sitzungen zu verwalten
	\item Detaillierte Signalisierung von RTP Audioströmen
	\item Kontrolle über jeden einzelnen Audiostrom auf clientseite
	\item Serverbasierte Lösungen möglich
	\item Dezentralisierte Lösungen möglich
\end{itemize}

Um eine funktionierende Implementierung in kürzester Zeit umzusetzen, wurden  existierende offene SIP Protokollstapel in Betracht gezogen. Dabei wurde zwischen server- und clientbasierten Komponenten unterschieden. 

\subsubsection{SIP-Server}
Für den Einsatz als Server bieten sich zwei große Pakete an, die beide den SIP-Standard nach RFC 3265 unterstützen. \textit{Asterisk}\footnote{Digium Inc, Programmversion 1.4.19, http://www.asterisk.org} unterstützt Voice-over-IP mit unterschiedlichen Protokollen  darunter sowohl SIP als auch das \textit{H323} Protokoll und bietet alle Möglichkeiten einer Anbindung an das Telefonnetz. 

Die Serveranwendung \textit{OpenSer}\footnote{AG Projects, Programmversion 1.3.1, http://www.openser.org} bietet ähnliche Funktionalität und kann als SIP-Proxy, Registrar, aber auch als Locations- und Applications-Server betrieben werden und bietet zusätzlich Unterstützung für das SIP-SIMPLE Protokoll. \textit{OpenSer} ist sowohl von eingebetteten System wie DSL-Routern bis zu großen Installationen mit mehreren Millionen Benutzern bei Internet Service Providern flexibel einsetzbar. Diese Eigenschaften haben den Ausschlag gegeben Openser als SIP Server einzusetzen. 

Darüber hinaus existieren noch etliche Open-Source und proprietäre SIP-Server-Lösungen, die hier nicht weiter erläutert werden. 

\subsubsection{SIP-Clients}

Auch bei den SIP-Clients existiert mittlerweile eine Vielzahl an speziellen ausgereiften kostenlosen \textit{Softphone} Lösungen. Einige der bekanntesten Open-Source \textit{Softphones} für Linux und Windows sind \textit{Ekiga}\footnote{Damien Sandras, Version 24.03.2008, http://www.gnomemeeting.org/}, \textit{KPhone}\footnote{Jan Janak, Version 24.03.2008, http://sourceforge.net/projects/kphone} \textit{Linphone}\footnote{Antisip, Version 24.03.2008, http://www.linphone.org} oder \textit{Minisip}\footnote{
Telecommunications System Laboratory, Version 25.03.2008, http://www.minisip.org}. Bei diesen handelt es sich um kostenlose Projekte die frei eingesetzt und modifiziert werden können. 

Zusätzlich existieren zwar freie Softphones, die von Infrastruktur-Betreibern kostenlos angeboten werden, um den eigenen Marktanteil am VoIP-Markt zu erhöhen. Dazu gehören Programme wie \textit{X-Lite}\footnote{Counterpath, Version 21.03.2008, http://www.xten.com}, \textit{Gizmo5}\footnote{SIPphone Inc, Version 21.03.2008, http://gizmo5.com} oder \textit{OpenWengo}\footnote{OpenWengo Inc, Version 21.03.2008, http://www.openwengo.org}. Diese haben meist einen großen Funktionsumfang, lassen sich jedoch nicht modifizieren. Zudem sind sie an die Nutzung der Infrastruktur eines bestimmten Betreibers gebunden.

Eine ausführliche und aktuelle Übersicht vieler auf auf dem Markt erhältlichen SIP Clients und Server Anwendungen ist im Internet verfügbar\footnote{Wikipedia:Overview of SIP Software, Version 22.03.2008, http://en.wikipedia.org/wiki/List\_of\_SIP\_software}

\subsubsection{SIP-Protokollstapel}
Neben kompletten Softphones existieren Plattform-übergreifende SIP-Protokollstapel, die die Funktionalität von SIP in größeren Anwendungen ermöglichen. Dazu zählen Protokollstapel wie \textit{OpenSipStack}\footnote{Joegen Baclor, Version 22.03.2008, http://www.opensipstack.org} \textit{sipXtackLib}\footnote{SIPfoundry, Version 22.03.2008, http://www.sipfoundry.org} \textit{reSIProcate}\footnote{B. Kampen, Version 22.03.2008, http://www.resiprocate.org} oder \textit{PJSIP}\footnote{Benjamin Prijono, Version 22.03.2008, http://www.pjsip.org}

\subsubsection{Pjsip}
Die Wahl fiel in dieser Arbeit aus den folgenden Gründen auf den offenen SIP Protokollstapel \textit{PJSIP}:

\begin{itemize}
	\item Plattformunabhängigkeit
	\item Mögliche Integration mit \textit{Irrlicht} dank C und C++ als Programmiersprache 
	\item Gute Dokumentation 
	\item Unterstützung des SIP Standards (PJSIP-CORE)
	\item Unterstützung des SIP-SIMPLE Standards (PJSIP-SIMPLE)
	\item Unterstützung für STUN, TURN und ICE (PJLIB-UTIL)
	\item Unterstützung moderner Audiocodecs wie z.B. \textit{Speex} (PJMEDIA-CODEC)
	\item Bereits existierender Medienstapel (PJMEDIA)
	\item Unterstützung von \textit{Asterisk} und \textit{Openser}
	\item Kontrolle jedes einzelnen Audiostroms (PJSUA-LIB)
\end{itemize}

\begin{figure}[tbh]
	\centering
		\includegraphics[width=0.70\textwidth]{grafiken/pjsip.eps}
	\caption{Übersicht der Komponenten des PjSIP-Protokollstacks}
	\label{fig:pjsip}
\end{figure}

Viele der existierenden SIP Clientanwendungen und Protokollstapel kamen für den Prototypen auch deshalb nicht in Frage, weil sie in einer anderen Programmiersprache als C oder C++ geschrieben waren und so nicht in das 3D-Framework integriert werden konnten. 

\section{Entwicklungsumgebung}

\subsection{Programmiersprache}
Der Einsatz von C und C++ als Programmiersprache wird durch mehrere Vorteile gerechtfertigt: Die Darstellung der virtuellen 3D Welt und die die Etablierung, Verarbeitung und Wiedergabe der Audioströme bilden zusammen ein Echtzeitsystem. Da in so einem System der gleichzeitige zeitnahe Ablauf mehrerer Prozesse erforderlich ist, wird eine sehr performante Programmiersprache benötigt. Es sind vor allem kurze Reaktionszeiten erforderlich, um für den Spieler eine glaubwürdige Illusion zu erzeugen. Beim Audiosignal reichen bereits Verzögerungen von mehr als 300ms aus, um eine Verständigung unverständlich zu machen. 

Da C und C++ maschinennahe Sprachen sind, und keine Interpretation des Quellcodes während der Laufzeit benötigen, besitzen sie einen Effizienzvorteil gegenüber Sprachen eine hohe Abstraktionsebene besitzen oder während der Laufzeit interpretiert werden müssen. Gerade deswegen liegen fast alle bisher vorgestellten Protokollstapel und Bibliotheken für VoIP oder 3D-Grafik ausschließlich in C oder C++ vor. 

\subsection{Testumgebung}
\label{testumgebung}
Die wiederkehrenden Tests wurden auf diversen mir zur Verfügung stehenden Systemen
durchgeführt. Als Clients kamen, zwei \textit{AMD Athlon(tm)} X2Dual 4200+, \textit{IBM} \textit{Thinkpad }T42 1,6GHz, \textit{Sony Vaio }CR 1,6GHz und \textit{HP Compaq }6710b 2,1GHz zum Einsatz. Um möglichst realistische Bedingungen zu schaffen, wurden die Rechner auf verschiedene Art und Weise an das Internet angebunden. Zwei Laptops nutzten ein 54Mbit WLAN mit VPN Anschluss, ein Laptop befand sich hinter einem NAT-Router mit WLAN, die stationären Rechner verfügten über einen direkten 100Mbit LAN Anschluss. In den Tests nutzten alle Rechner den Breitbandanschluss der Universität Mannheim, der über 33 MBit Down- und 16 MBit Upload verfügt. 

Auf den folgenden Seiten soll nun die Umsetzung, der in Kapitel 3 erarbeiteten Konzepte und Verbesserungsvorschläge erläutert werden. Es werden ausgewählte Probleme und Lösungswege beschrieben, die in dieser Phase der Arbeit aufgetreten sind. 

\section{3D-Spielewelt mit Irrlicht und Irrklang}

\subsection{Irrlicht}

\subsubsection{Initialisierung}
Zu Beginn des Spieles werden die \textit{Irrlicht} und VoIP Instanzen initialisiert, die später in zwei verschiedenen Prozessen parallel ablaufen und miteinander zusammenarbeiten. In \textit{Irrlicht} wird die 3D-Welt gerendert und die Darstellung und Steuerung des Avatars vorgenommen und in der VoIP-Instanz die Audiokommunikation signalisiert und durchgeführt.

\subsubsection{Level}
%Todo bild vom Level
\begin{figure}[tbh]
	\centering
		\includegraphics[width=1.00\textwidth]{grafiken/spielewelt-screenshot.eps}
	\caption{Realistische 3D-Spielewelt mit Radar}
	\label{fig:spielewelt-screenshot}
\end{figure}

Für eine möglichst realistische Umsetzung wurde ein Level benutzt, das einen Park zeigt in dem Spieler die Möglichkeit haben sich frei zu bewegen. Die Vorstellung, dass Menschen in hier spontane Gesprächen führen liegt nahe. Ebenso erscheint in diesem Szenario die Übertragung der Sprache per Luft sehr natürlich.

//AVATARE MD2 Modelle
//Level Park in Montreal
%\subsubsection{\textit{Collision Detection}}
%Der Spieler kann in der Implementierung mit andern Spielern des Levels und dem Level selbst interagieren. Dabei ist es wichtig, dass eine Berechnung der Kollision des Spielers mit dem Level oder anderen Spielern stattfindet, da ohne eine solche der Spieler alle Gegenstände durchdringen könnte und das Szenario unnatürlich erscheint. Diese Berechnung wird "`\textit{Collision Detection}"' genannt und wird ebenfalls mit im \textit{Irrlicht} Framework umgesetzt. 

\subsubsection{Steuerung}
Der Spieler ist in der Lage sich in alle Richtungen zu Bewegen und zu springen. Dies erlaubt es ihm sich anderen Spielern zu nähern, um so die Sprachkommunikation einzuleiten. Bis auf die Steuerung des Avatars sind keine weiteren Tastenkombinationen nötig, um eine Sprachkommunikation einzuleiten. Diese findet automatisch statt, wenn der Spieler die entsprechende Distanz zum anderen Spieler unterschritten hat. Dies wird in einem Radar, das die verschiedenen Verbindungsstufen abbildet oben links auf dem Bildschirm angezeigt. Eine Liste unten links zeigt zusätzlich alle Teilnehmer des Spiels und die Teilnehmer der persönlichen Konferenz an. 

\subsubsection{Radar}

In einem Radar am oberen-linken Bildschirmrand werden für den Spieler alle Teilnehmer des Spiels angezeigt. Das Radar verfügt über drei Zonen, die die einzelnen Verbindungsstufen repräsentieren. Spieler werden mit einem Icon und ihrem zugehörigen Namen angezeigt. In der öffentlichen Zone wird das Icon gräulich dargestellt, betreten sie die soziale Zone, wird dieser grün gefärbt und in der privaten Zone ist ihr Icon gelb. Die Metapher der Luftübertragung, gepaart mit dem Radar als Orientierungshilfe, unterstützt den Spieler bei der Adressierung von anderen Teilnehmern. Spieler sind direkt in der Lage zu sehen, an wen ihre Sprachnachrichten übertragen werden und welche Teilnehmer sie gerade hören. 

\subsection{Irrklang}

\subsubsection{Lokale Audioszene}
Das Level wurde zusätzlich mit mehreren lokalen Audioquellen ausgestattet, die eine realistische Audioumgebung simulieren. So sind der Wind, der Springbrunnen und die Fahrzeuge des Levels mit entsprechenden Audiodateien unterlegt, die mit Hilfe der Irrklang-Engine für das Ohr dreidimensional positioniert werden können. Die Audioszene wird lokal erzeugt und muss im Gegensatz zur Sprachkommunikation nicht über das Netzwerk übertragen werden. Die Sprachkommunikation und die lokale Audioszene existieren simultan und erzeugen so für den Spieler eine realistische Illusion. 

\section{PjSIP-VoIP-Instanz}

Die VoIP-Instanz unterscheidet zwischen der Signalisierung (PJSIP) und der Kontrolle und dem Fluss des Audiostroms(PJMEDIA). Es existiert sowohl eine \textit{Low-level-API} (PJSIP \& PJMEDIA), als auch eine \textit{High-level-API}(PJSUA). Die gleichzeitige direkte Nutzung der PJMEDIA und PJSIP Pakete bietet eine direkte Kontrolle über jeden Schritt der Anwendung. Die PJSUA-API dagegen, erlaubt es die Signalisierung, Account-Management, Buddy-Management, Präsenz, Instant-Messeging, Konferenzen und Medien-Funktionalitäten zu abstrahieren. 

\subsection{Signalisierung mit PJSUA}
// TODO Vieleicht doch ein bisschen CODE? 

\subsection{Medienfluss}
\begin{figure}
	\centering
		\includegraphics[width=1.00\textwidth]{grafiken/pjsip-mediaflow.eps}
	\caption{Eine Übersicht über den Audiofluss in PjSIP}
	\label{fig:pjsip-mediaflow}
\end{figure}

Die Hauptkomponenten der Abbildung \ref{fig:pjsip-mediaflow} bestehen aus:
\begin{itemize}
	\item einem Soundkarten-Port, der eine Abstraktions-Ebene darstellt, die die Callbacks der Soundkarte in Audioframes übersetzt
	\item einer Conference-Bridge, die ein Mischen der Audiosignale erlaubt
	\item einem Medienstrom, der bei einem Anruf erstellt wird.
	\item einem Medientransport, der für die Übertragung des Medienstroms durch RTP/RTCP Pakete zuständig ist.
\end{itemize}

Während der Initialisierungsphase, erstellt die Anwendung einen logischen Sound\-karten-Port und die Conference-Bridge. Diese zwei Objekte bleiben während der Lebenszeit der Applikation erhalten. Wird ein Anruf getätigt oder entgegengenommen, erstellt die Anwendung eine Instanz des Media-Transports (normalerweise UDP). Die Adresse(Port) des Media-Transports wird als Parameter der SDP IVITE Nachricht übergeben (empfangen). Ist die Verbindung etabliert, wird eine Medien-Sitzung erstellt. Die Anwendung kann nun den Audiostrom der Medien-Sitzung nutzen und ihn bei der Conference-Bridge registrieren. Danach kann dieser \textit{Audiostrom-Slot} in der Conference-Bridge mit Slots anderer Audioströme verbunden werden oder mit dem sog. "`zero-slot"', der direkt mit der Soundkarte und dem Mikrofon verbunden ist. 

\section{Zusammenarbeit von Irrlicht und VoIP}

\subsection{Aktualisierung der VoIP Instanz}

Im Spiel selbst ist der \textit{Irrlicht-Scene-Manager} für eine Verwaltung aller Objekte der Spielewelt verantwortlich. Er verfügt sowohl über die Koordinaten des Spielers und aller lokalen Objekte, kann aber auch über die Koordinaten aller anderen anwesenden Spieler im Spiel informiert werden. Erhält der Spieler neue Positionsinformationen von anderen Teilnehmern, werden diese im \textit{Scene-Manager} aktualisiert. Genauso versendet der Spieler selbst seine eigenen Koordinaten an alle teilnehmenden Spieler.

Die Aktualisierung aller Positionsinformationen findet (alle 10 Frames) in der Hauptschleife von \textit{Irrlicht} statt, in der sowohl die 3D Welt als auch die lokale VoIP Instanz aktualisiert wird. Anhand der Koordinaten aller aktiven Spieler des Scene Managers kann die die VoIP Instanz die entsprechenden Distanzvektoren berechnen. Die Anzahl der dargestellten Frames hängt dabei stark von der Grafikleistung des Rechners ab und lag bei den Testmaschinen zwischen 5fps und 53fps.
 
Unterschreitet ein Spieler die Entfernung zu einem anderen Spieler, veranlasst die VoIP-Instanz einen entsprechenden Anruf zu diesem Teilnehmer. In Abhängigkeit der Entfernung voneinander werden die entsprechenden Zonenmechanismen durch die VoIP-Instanz im Hintergrund eingeleitet. Hier werden vor allem Callbacks zwischen Irrlicht und der VoIP Instanz genutzt um entsprechende Events auszulösen. 

\subsection{Buddy Konzept}

Die Spieler im Spiel werden durch Avatare repräsentiert. Jedem Avatar im Spiel ist ein entsprechender "`Buddy"' in der VoIP-Instanz gegenübergestellt. Diese hält somit eine lokale Liste aller Mitspieler vor. Sämtliche Sprachkommunikation findet durch einen Anruf zum entsprechendem \textit{Buddy} statt. Falls sich mehrere Personen in der Hörnähe des Spielers befinden, werden auch mehrere Anrufe zu den entsprechenden Personen veranlasst. Da für jeden Teilnehmer ein eigener Anruf getätigt und separat verwaltet wird, ist der Spieler in der Lage die Parameter wie Lautstärke, Bitrate und Codec jedes einzelnen Anrufs zu verändern und neu auszuhandeln. Alle getätigten Anrufe werden in der lokalen \textit{Conference-Bridge} abgemischt.

\subsection{Conference-Bridge}
Die Aufgabe der \textit{Conference-Bridge} besteht die Audioströme bestehender SIP Anrufe lokal abzumischen (siehe Abbildung \ref{fig:conference-bridge}). Jeder Teilnehmer der Conference-Bridge verfügt über einen Eingangs- und Ausgangs-Kanal, die beliebig miteinander verschaltet werden können. Das Mikrofonsignal des Spielers wird unverändert an alle Teilnehmer der Conference-Bridge übertragen. Die empfangenen Signale werden jedoch in ihrer Lautstärke angepasst. Dabei wird die Lautstärke der jeweiligen Audioströme mit dem Parameter $r$ zwischen 0 und 1 gewichtet, bevor sie addiert werden. So kann die Entfernung des Teilnehmers simuliert werden. Die Parameter $r$ werden anhand der Distanz der Avatare vom Spieler errechnet, die auf einen Bereich zwischen 0 und 1 normiert wird. Überschreiten Spieler im Spiel die Maximaldistanz der sozialen Zone, werden die Teilnehmer aus der Konferenzbrücke entfernt, der logische SIP Anruf jedoch so lange erhalten bis sie auch die öffentliche Zone verlassen haben. Dieses Verhalten wird später in Abschnitt \ref{Zonen-Implementierung} beschreiben. Liegen die Audiosignale in verschiedenen Abtastraten vor, übernimmt die Conference-Bridge automatisch ein \textit{Resampling} des Signals. 

\begin{figure}
	\centering
		\includegraphics[width=1.00\textwidth]{grafiken/conference-bridge.eps}
	\caption{Funktionsweise der Konferenzbrücke mit 5 Teilnehmern und Anpassung der einzelnen Audioströme}
	\label{fig:conference-bridge}
\end{figure}

\subsection {Erweitertes Audio-Mixing}
Da bisher die Teilnahme an einer Konferenz binär gelöst wurde, waren Spieler entweder Teil einer solchen oder nicht. So ist das in einer Konferenz mit \textit{n} Teilnehmern ${p_{1},p_{2},...,p_{n}}$, mit Audioströmen ${V_{1}(t),V_{2}(t),...,V_{n}(t)}$, von einem Teilnehmer $i$ zu einer Zeit \textit{t} empfangene Signal $R_{i}(t)$ aller Teilnehmer $j$ definiert durch:

\begin{align}
	R_{i}(t) = \sum \limits_{j=1}^n {V_{j}(t)}  \ \ \mbox{wobei} \  1 \geq j \geq n \ \mbox{und} \  j \neq i
\end{align}

Der Verbesserungsvorschlag sieht vor den binären Teilnahmestatus durch eine stetige Teilnahmefunktion zu ersetzen.  Die Teilnahme an einer Konferenz soll von der Distanz $d_{j}$ zum anderen Teilnehmer abhängig sein und somit alle Werte zwischen 0 und 1 annehmen. Das empfangene Signal $R_{i}(t)$ wird somit definiert als:

\begin{align}
	R_{i}(t) = \sum \limits_{j=1}^n {d_{j} \cdot V_{j}(t)} \ \ \mbox{wobei} \ 1 \geq j \geq n \ \mbox{und} \ j \neq i
\end{align}

In einer 3D Umgebung, in der die Spieler beliebige Positionen zueinander einnehmen können, wird vom Spieler ein Distanzvektor zu den übrigen Spielerpositionen berechnet und die Lautstärke des entsprechenden Audiostroms anhand diesem angepasst. Ein solcher Ansatz ermöglicht es für den Spieler eine eigene Konferenz zu erstellen, in der die Teilnehmer nur zu einem bestimmten Prozentsatz, repräsentiert durch ihre Lautstärke, anwesend sind. 

Personen die sich in der Nähe befinden sind besser zu hören, als Personen die sich weit entfernt befinden. Die Kontrolle der Konferenz findet somit nicht direkt durch Tastatureingaben statt, sondern hängt implizit von der Position und Bewegung der Spieler zueinander ab. Um dieses Mixingkonzept zu realisieren, wird das Modell der Proxemik eingesetzt, das bereits im zweiten Kapitel vorgestellt wurde.

\section{Spielablauf}

\subsection{Registrierung}
Bevor das eigentliche Spiel stattfindet, registriert sich der Spieler bei einem voreingestellten Registrar. Dazu sendet er seine Anmeldung gemäß dem im Kapitel 3 vorgestellten Registrierungsprozess. Ist die Registrierung abgeschlossen, ist der Registrar in der Lage diesen Spieler erfolgreich zu lokalisieren. Während der Registrierungsphase wird auch ein öffentlicher STUN-Server kontaktiert, der es dem Spieler erlaubt seine öffentliche IP Adresse und den Typ des eingesetzten Routers herauszufinden. 

\begin{figure}
	\centering
		\includegraphics[width=0.3\textwidth]{grafiken/gamestart-screenshot.eps}
		\caption{Startbildschirm des Spiels}
\end{figure}

\subsection{Spieler startet das Spiel}
Auf dem Startbildschirm findet der Spieler seine bisherigen Freunde vor und kann ihren aktuellen Status ablesen: Diese können entweder \textit{offline}, \textit{online} oder gerade \textit{im Spiel} sein. Möchte der Spieler das Spiel betreten, kann er einen aktiven Spieler anwählen und mit dem Drücken des \textit{Join}-Knopfs am Spiel teilnehmen. Möchte er ein neues Spiel starten, kann er mit dem Betätigen des \textit{Create}-Knopfes ein neues Spiel anlegen. 

\subsection{Neuer Spieler betritt das Spiel}
Betritt ein neuer Spieler das Spiel, so wird er von diesem Zeitpunkt ab vom lokalen \textit{Scene-Manager} verwaltet und in der 3D-Welt als neuer Avatar dargestellt. Ein solcher wird für jeden neuen Spieler an einer festgelegten Einstiegskoordinate erzeugt. Gleichzeitig wird die SIP-Adresse des neuen Teilnehmers in die lokale \textit{Buddyliste} des Spielers aufgenommen. Befindet sich der entsprechende Spieler in Hörnähe, wird ein Anruf zu diesem Teilnehmer in der VoIP-Instanz ausgeführt.

\subsection{Spieler bewegt sich im Spiel}
Jeder Spieler ist in der Lage sich frei im Level zu bewegen. Jede Bewegung wird allen anderen Teilnehmern mitgeteilt, damit sie in der Lage sind ihre Spielewelt konsistent zu halten. Auf die gleiche Weise erhält der Spieler selbst ebenfalls Bewegungsinformationen aller Spieler des aktiven Spiels. Diese Aktualisierung wird alle 10 Frames vorgenommen. Anhand der Positionsinformationen der Spieler wird die Sprachkommunikation entsprechend des Zonenkonzepts eingeleitet.

\subsection{Spieler beendet sein Spiel}
Beendet ein Spieler sein Spiel, so bedeutet es für die übrigen Spieler nicht das Ende des kompletten Spiels. Das Verlassen eines Teilnehmers hat als einziges zur Folge, dass dieser seine Positionsinformationen nicht mehr versendet und auch keine weiteren mehr empfängt. Alle aktiven Gespräche mit diesem Spieler werden ebenfalls beendet. Eine frühe Implementierung nutzte spezielle Nachrichtentypen, um dies zu signalisieren. In einer späteren Version wurde jedoch der SIP-Präsenzdienst dazu eingesetzt\footnote{Eine genaue Beschreibung dieses Dienstes findet sich in Kapitel 4. Die Implementierung wird in Kapitel 9 erläutert.}.

\subsection{Verbindungsaufbau}
Befinden sich zwei Teilnehmer in einer entsprechenden Hörnähe, wird diese Bedingung sie dazu veranlassen eine Verbindung untereinander aufzubauen. Dabei findet der Verbindungsaufbau entsprechend des SIP Protokolls statt, besitzt jedoch einen signifikanten Unterschied, der im Folgenden erklärt werden soll:

Möchte Teilnehmer A zu Teilnehmer B eine Verbindung herstellen, sendet er eine SIP-Nachricht INVITE an Teilnehmer B. Die Nachricht enthält die Beschreibung der RTP-Session nach dem SDP Protokoll und alle notwendigen Angaben. Teilnehmer B sendet die gleiche Nachricht, da er auch eine Verbindung herstellen möchte.

Falls ein Teilnehmer die INIVTE Nachricht erhält, prüft er ob er gerade eine Verbindung zum anderen Teilnehmer aufbaut, oder bereits eine Verbindung aufgebaut hat. Ist das der Fall, so antwortet er auf den ankommenden Anruf mit der Response-Nachricht \textit{403 Forbidden}. Diese Vorgehenswiese weicht vom SIP-Standard ab und wird im anschließenden Abschnitt behandelt.

Baut Teilnehmer B jedoch noch keine Verbindung zum anderen Teilnehmer auf und ist auch nicht mit ihm verbunden, so funktioniert der Rufaufbau wie gewohnt. Hat ein Teilnehmer die Verbindung akzeptiert, sendet er einen SIP-Response 200 OK, der vom anderen Teilnehmer mit der ACK-Nachricht bestätigt wird. Mit dem Empfang der ACK-Nachricht, ist die logische Verbindung abgeschlossen. Nun kann eine Verbindung nach dem Protokoll RTP verlaufen und es besteht eine Sitzung zwischen den Teilnehmern. 

\subsubsection{Das Problem der doppelten Verbindung}
Da Teilnehmer zwar zentral lokalisiert werden, jedoch unabhängig von einer zentralen Instanz Verbindungen signalisieren können, kann der Fall auftreten, dass beide Teilnehmer zeitgleich eine Verbindung miteinander aufbauen wollen. Dies geschieht immer dann, wenn beide Spieler im Spiel die erforderliche Nähe zueinander erreicht haben. Dann versucht sowohl Teilnehmer A eine Verbindung zu Teilnehmer B, als auch Teilnehmer B eine Verbindung zu Teilnehmer A aufzubauen. Dies entspricht dem Problem im Alltag, wenn zwei Personen versuchen zur exakt gleichen Zeit anzurufen und jeder nur ein Besetztzeichen hört. 

\begin{figure}[tbh]
	\centering
		\includegraphics[width=0.60\textwidth]{grafiken/sipanruf_403.eps}
		\caption{Ablauf einer symmetrischen Verbindung}
	\label{fig:sipanruf_403}
\end{figure}

Bei diesem Szenario können zwei verschiedene Fälle auftreten. Der einfache Fall liegt vor, wenn bei Teilnehmer B eine INVITE-Nachricht von A eintrifft und B bereits mit A verbunden ist. Dann kann er den zweiten Dialog einfach verwerfen, da ja bereits eine bestehende Verbindung existiert.

Der kompliziertere Fall ist der symmetrische Fall: Dieser tritt dann ein, wenn B während er selbst eine Verbindung mit A aufbaut, die INVITE-Nachricht erhält. Hier hat B hat ebenfalls eine INVITE Nachricht an A geschickt, während A zur gleichen Zeit auch eine INVITE Nachricht an B geschickt hat. Lehnen nun beide Teilnehmer die Verbindung ab, so führt es dazu, so kommt in diesem Fall überhaupt keine Verbindung zwischen den Teilnehmern zustande. 

Hierbei ist die Existenz einer gemeinsamen Regel für alle Teilnehmer wichtig, nach der sie beim Dialog-Aufbau vorgehen. Die hier gewählte Lösung sieht vor, dass beide Teilnehmer eine zufällige Zeit $t$ warten und danach versuchen eine neue Verbindung zu etablieren bis der unsymmetrische Fall auftritt. Diese Vorgehensweise hat sich in der Praxis bewährt. 

\subsection{Verbindungsabbau}
Der Verbindungsabbau findet wie gewohnt statt: Befindet sich Teilnehmer B nicht mehr in Verbindungsreichweite zu Teilnehmer A so beenden beide die Verbindung zueinander. Dazu senden sie eine BYE Nachricht an den anderen Teilnehmer, die mit einer ACK Nachricht bestätigt wird. 

\section{Zonen}
\label{Zonen-Implementierung}
Die Umgebung des Spielers wurde wie gefordert in drei Zonen unterteilt. 

\begin{figure}[htbp]
	\centering
		\includegraphics[width=.90\textwidth]{grafiken/zonenkonzept2.eps}
	\caption{Zonenkonzept und daraus resultierende Funktionalität}
	\label{fig:zonenkonzept}
\end{figure}

\subsection{Öffentliche Zone}
Die öffentliche Zone wird genutzt, um SIP Verbindungen des Spielers mit anderen Teilnehmern zu initiieren und so eine Grundkonnektivität zwischen diesen herzustellen. Da der Verbindungsaufbau mitunter bis zu 1 oder 2 Sekunden betragen kann, wird diese Zone dazu genutzt, um vorab die gesamte Signalisierung vorzunehmen, bevor die Teilnehmer tatsächlich die nötige Hörnähe eingenommen haben, um miteinander zu sprechen. So soll die entstehende Latenz beim Verbindungsaufbau für den Spieler nicht erkennbar sein. 

Durch die Existenz der öffentlichen Zone kann der Übergang stufenweise von nicht verbundenen Teilnehmern, über Teilnehmer, die bereits auf logischer Ebene verbunden sind, bis hin zu Teilnehmern, die tatsächlich Audiodaten austauschen, stattfinden. 

In dieser Zone werden deshalb logische SIP Verbindungen aufgebaut, weil es sehr wahrscheinlich ist, dass die Teilnehmer, die bereits diese Entfernung eingenommen haben, auch die soziale Zone betreten werden, in der tatsächlich eine Audioverbindung stattfindet. 

Da Spielergruppen in virtuellen Welten, der Erfahrung nach, während der Spielesitzung eine geringe Entfernung zu anderen Mitgliedern der gleichen Gruppe beibehalten, soll durch eine öffentliche Zone sichergestellt werden, dass bereits eine Konnektivität zwischen allen Teilnehmern herrscht, damit eine Sprachkommunikation zwischen diesen Spielern verzögerungsfrei stattfinden kann. Diese Grundkonnektivität beansprucht dabei eine minimale Bandbreite, gewährleistet aber einen raschen Aufbau der Audiokommunikation. 

\subsubsection{Eingang und Verlassen der Öffentlichen Zone}
Die öffentliche Zone kann aus zwei Richtungen betreten werden. Wird sie von außen betreten, wird eine logische SIP Verbindung zwischen den Teilnehmern aufgebaut. Der doppelte Verbindungsaufbau und die entstehenden Probleme wurden oben bereits beschrieben. Befindet sich der Teilnehmer erst einmal in der öffentlichen Zone, wird eine Reduzierung der Bandbreite vorgenommen.

In der Implementierung wurden zwei Mechanismen ausprobiert, um einen geringen Bandbreitenverbrauch in dieser Zone zu gewährleisten ohne jedoch die logische SIP Verbindung zu beenden. Dabei wurden die speziellen Eigenschaften der verwendeten Protokolle SIP und RTP ausgenutzt.

\subsubsection{RTP - Silence Supression}
Während der logische SIP Anruf weiterhin erhalten bleibt, wird auf auf RTP Ebene kein weiteres Audiosignal mehr übertragen. Dies geschieht, in dem die Teilnehmer aus den jeweils lokalen lokalen Konferenz genommen werden und so das Mikrofonsignal nicht mehr übermittelt wird. 

Da kein Audiosignal mehr an die gegenseitigen Spieler übertragen wird, wird von nun an eine \textit{Silence Suppression} vorgenommen. Dieses Verhalten entspricht der im Kapitel 3 geschilderten Eigenschaften der \textit{Silence Supression} des RTP Protokolls. Der Unterschied besteht darin, dass die \textit{Silence Supression} nicht von der tatsächlichen Stille im Mikrofon abhängt, sondern von der Entfernung der Teilnehmer untereinander. 

Diese Methode bietet die Möglichkeit, den Bandbreitenverbrauch in dieser Zone auf unter 1kB/s \footnote{Messungen zum Bandbreitenverbrauchs in dieser Zone finden sich in Kapitel 10.} zu reduzieren. Der große Vorteil dieses Verfahrens besteht darin, dass der Wechsel zwischen der öffentlichen und sozialen Zone verzögerungsfrei stattfinden kann, da kein neues Aushandeln der Parameter benötigt wird.

\subsubsection{SIP - HOLD}
Eine Reduzierung des Bandbreitenverbrauch wurde auch mit der SIP HOLD Funktionalität ausprobiert. Hierbei signalisiert das SIP Protokoll, dass der Anruf "`geparkt"' werden soll und die RTP Verbindung während des Hold Vorgangs beendet wird. Wird der Hold aufgehoben, wird die RTP Verbindung wieder neu etabliert. Die Messergebnisse\footnote{Siehe Kapitel 9} und eigene Erfahrungen haben gezeigt, dass zwar eine noch größere Einsparung der Bandbreite, als bei der RTP Silence Supression stattfindet, da praktisch keine Daten mehr übertragen werden. Der Nachteil jedoch besteht darin, dass beim Wiederaufnehmen des Anrufs eine spürbare Verzögerung auftritt, da die Verbindungsparameter des Gesprächs wieder neu verhandelt werden müssen.

\begin{figure}[tbh]
	\centering
		\includegraphics[width=0.60\textwidth]{grafiken/siphold.eps}
	\caption{Schematischer Ablauf des SIP-HOLD Nachrichtenverlaufs}
	\label{fig:siphold}
\end{figure}

\subsection{Soziale Zone}
In der sozialen Zone werden die Teilnehmer mit denen bereits Verbindungen aufgebaut wurden, nun der eigenen lokalen Konferenz hinzugefügt. Innerhalb dieser Konferenz wird die Lautstärke der Teilnehmer gemäß ihrer Entfernung angepasst. Audiosignale von Teilnehmern, die sich am inneren Rand der sozialen Zone des Spielers befinden werden ungedämpft mit einer Lautstärke von 100\% abgemischt. Diese nimmt linear in Abhängigkeit der Entfernung zu den Spielern ab, bis sie am äußersten Rand der Zone 0\% beträgt. 

\subsubsection{Lautstärkenanpassung}
Da die Lautstärke der übertragenen Stimme bei einer Übertragung durch Luft mit zunehmender Entfernung abnimmt wurde ein einfaches physikalisches Modell der Schallübertragung benutzt: Generell gilt, dass Schalldruck bei zunehmender Entfernung $r$  mit $1/r$ abnimmt. Da sich die Schallintensität auf eine immer größer werdende gedachte Kugeloberfläche (proportional zur Entfernung $r$) verteilt, nimmt sie mit der Entfernung quadratisch ab. 

Zu Testzwecken wurden sowohl die lineare als auch die quadratische Abnahme der Schallintensität modelliert, um festzustellen welche Veränderung natürlicher erscheint. Die lineare Abnahme erwies sich sich als transparenter für den Benutzer, da eine einfachere Relation zwischen Lautstärke und Entfernung hergestellt werden konnte. 

Als ein Problem bei der Lautstärkenanpassung erwies sich die unterschiedliche Aufnahmelautstärke der Mikrofone. Da verschiedene Mikrofone eine unterschiedliche Sensibilität haben, senden Spieler unter Umständen bei gleicher Entfernung verschieden laute Signale. In einem fertigen Produkt, sollte das Mikrofon dynamisch auf einen bestimmten Pegel normiert werden, bevor das Spiel beginnt. Solche Verfahren sind Standard bei VoIP Telefonen und könnten später leicht nachgerüstet werden. %http://www.sengpielaudio.com/Rechner-entfernung.htm

\subsubsection{Audiocodec}
In der sozialen Zone wird ein Audiocodec mit einer niedrigen Bitrate eingesetzt, um eine größere Anzahl an möglichen Mitspielern zu ermöglichen. In den Testszenarios habe ich mich für den Speex Codec mit einer Abtastrate von 16kHz und einer Bitrate von 11 Kb/s entschieden, der einen MOS Wert von über 4 liefert. Es ist natürlich vorstellbar auch qualitativ schlechtere Codecs mit einer noch geringeren Bitrate einzusetzen, um dem Spieler noch mehr Verbindungen zu ermöglichen. Diese Entscheidung kann in einem fertigen Produkt entweder dem Spieler selbst - bei einer manuellen Konfiguration - überlassen werden oder automatisch anhand der verfügbaren Bandbreite bestimmt werden. So könnten Spieler mit einer höheren Bandbreite auch ein besseres Audiosignal verbreiten, während Spieler mit einer schwachen Anbindung nur Codecs mit einer niedrigen Bitrate einsetzen könnten.

\subsection{Private Zone}

\subsubsection{Lautstärke}
In der privaten Zone A bleibt die Laut\-stärke der Teilnehmer konstant bei 100\%. Dies ermöglicht den Teilnehmern sich in einem kleinen Radius umeinander zu bewegen, unt trotzdem immer noch mit einer optimalen Lautstärke zu kommunizieren. 

\subsubsection{Audiocodec}
Zusätzlich dazu ist in einem Testszenario eine weitere Unterscheidung zur sozialen Zone getroffen worden, indem in der privaten Zone ein qualitativ höherwertiger Codec mit einem größeren MOS Wert verwendet wird. Diese Vorgehensweise soll dafür sorgen, das Mitspieler in unmittelbarer Nähe besonders gut verständlich sind. Im Gegensatz zur Sozialen Zone wird erwartet, dass nur wenige Spieler diese Zone betreten, da angelehnt an die Erkentnisse aus Kapitel 2 Menschen in virtuellen Welten ähnliche Distanzzonen einnehmen wie im realen Leben. In der Implementierung wurde in einem Testszenario für die private Zone der Speex Codec mit einer Abtastrate von 16 kHz verwendet, während in der Sozialen Zone der Speex Codec mit einer geringen Abtastrate von 8 kHz eingesetzt wurde. 

\section{PTSN-Netzwerke}
Durch die Möglichkeit SIP Server mit externen Gateways zu verbinden, wurde auch die Metapher des Festnetz-Telefons umgesetzt, dass dem Spieler tatsächlich erlaubt aus der virtuellen Welt in die reale Welt zu telefonieren. Dazu wurde das Modell einer Telefonzelle auf dem Spielfeld platziert. Befindet sich der Spieler in unmittelbarer Nähe zu dieser Telefonzelle, findet ein Anruf an eine beliebige Telefonnummer statt. Dieses \textit{Proof of Concept} zeigt, dass mit Hilfe eines standardisierten Protokolls solche Möglichkeiten sehr einfach realisiert werden können. 