\chapter{VoIP und SIP}

Unter der IP-Telefonie, eine Kurzform für die Internet-Protokoll-Telefonie, auch kurz Internet-Telefonie oder auch Voice over IP (kurz VoIP) genannt, versteht man das Telefonieren über Computernetzwerke, welche nach Internet-Standards aufgebaut sind. Dabei werden für Telefonie typische Informationen, d.h. Sprache und Steuerinformationen z.B. für den Verbindungsaufbau, über ein auch für Datenübertragung nutzbares Netz übertragen. Bei den Gesprächsteilnehmern können sowohl Computer, für IP-Telefonie spezialisierte Telefonendgeräte, als auch über spezielle Adapter angeschlossene klassische Telefone die Verbindung ins Telefonnetz herstellen.

\subsection{Protokolle zur Echtzeitkommunikation}
Voice-over-IP beinhaltet unterschiedliche Protokolle. Zur reinen Signalisierung werden hauptsächlich das Session Initiation Protocol (SIP) \citep{needed} bzw. Protokolle aus der H.323-Protokollfamilie verwendet. Bei VoIP sing generell folgende Klassen der Protokolle zu unterscheiden:
\begin{itemize}
	\item Protokolle für die Sprachübermittlung: Da die Sprachkommunikation in Echtzeit verläuft, sind spezielle Protokolle für die Übermittlung der Sprache über IP-Netze nötig.
	\item Signalisierungsprotokolle: Es handelt sich hier um Protokolle für den Auf- und Abbau von Verbindungen zwischen zwei IP-Telefonen.
	\item Diese Protokolle sind nötig, um die klassischen TK-Systeme und -Netze, wie z.B. das ISDN mit den IP-Netzen mit Hilfe von verschiedenen Gateways zu integrieren. 
\end{itemize}

Vorgänge wie die Vermittlung von Gesprächen, der Rufaufbau oder -abbau sowie die Aushandlung von Parametern, z.B. die Verwendung eines gemeinsamen Codecs, der entsprechenden Bitrate oder der maximal zulässigen Bandbreite werden in diesen Protokollen kontrolliert. Speziell für diese zwecke wurde das Session Description Protocol (SDP) \citep{needed} entwickelt um den Medienstrom zu kontrollieren. SIP basiert auf den gleichen Prinzipien, die man beim HTTP(HyperText Transfer Protocol) nutzt. 

Für die Sprachübertragung wird das Real-time Transport Protocol (RTP) \citep{needed} verwendet, das dem Empfänger der Pakete erlaubt, trotz unzuverlässiger Übertragung über UDP \citep{needed}, einen Paketverlust festzustellen und die ursprüngliche Reihenfolge der Daten wiederherzustellen. RTP ist ein Transprotokoll, ist also nicht nur für Sprache, sondern für alle Echtzeitmedien, wie Video verwendbar. Da RTP keine Bestätigungen verwendet, kann der Empfänger dem Sender nicht mitteilen, ob überhaupt btw. wie die Sprache in Form von IP-Paketen bei ihm ankommt. Das RTCP Protokoll gleicht diesen Nachteil aus: Mit Hilfe des RTP Control Protocols (RTCP) können zusätzlich zu den reinen Mediendaten auch Kontrollinformationen wie die Anzahl der verlorenen Pakete oder der gemessene Jitter \citep {needed} der RTP-Verbindung übertragen werden und so Übertragungsparameter angepasst werden. 

Neben den bisher erwähnten Protokollen zur Hauptfunktionalität gibt es noch noch weitere, die sich mit allen angrenzenden Bereichen von VoIP beschäftigen. So wird mit Hilfe des STUN (Simple Traversal of User Datagram Protocol Through Network Address Translators) ermöglicht seine IP-Adresse zu ermitteln, falls man sich hinter einem NAT Router befindet und die interne IP-Adresse nicht der externen entspricht. Dies ist vor allem notwendig, da die IP-Kontaktinformationen in SIP und SDP in der Anwendungsschicht übertragen werden und somit ein Client ohne Kentniss richtigen Adresse falsche Informationen liefern würde. Ein weiteres Protokoll mit dem Ziel der Überbrückung eines NATs ist TURN(Traversal Using Relay NAT) \citep{needed}. Bei TURN bekommt ein Client von einem TURN-Server eine öffentlich erreichbares IP-Adressen- und Port-Paar zugewiesen und leitet alle an diese öffentliche Adresse ankommenden Pakete an den Client weiter. 

Für die Ansteuerung von VoIP-Gateways stehen die Protokolle MGCP(Media Gateway Control Protocol) nund Megaco(Media Gateway Control) zur Verfügung, die im Rahmen der Arbeit jedoch nicht weiter erläutert werden. 

Dieses Kapitel soll zunächst den Aufbau eines VoIP Systems beschreiben um anschließend die Protokolle SIP/SDP, RTP und RTCP zu behandeln. Da SIP die ältere H.323 Protokollfamilie in langfristig verdrängen wird, wird diese Protokollfamilie nicht behandelt. Im Abschluss wird ein Überblick über das propriätere Protokoll von Skype gegeben, dessen Funktionsweise und Details zwar nicht offen sind, es jedoch eine Alternative zu den offenen Protokollen bietet. 

\subsection{Einfaches VoIP System}
Der einfache Aufbau eines funktionierenden VoIP Systems kann prinzipiell mit einer bestehenden IP-Infrastruktur und Softphones (Programmen die Telefone emulieren), die auf Rechners ausgeführt werden, funktionieren. Die Teilnehmer müssen jedoch bei einer solchen Konfiguration die IP-Adressen der gewünschten Gesprächspartner kennen um einen direkten Anruf auszuführen. Bei einer Adressänderung der IP Adresse eines Gesprächspartners, müssten jedoch alle Einträge der Gesprächspartner entsprechend abgeändert werden, weil sich die Teilnehmer sonst nicht mehr erreichen könnten. Der gleiche Aufwand müsste auch beim Hinzufügen weiterer Teilnehmer erfolgen. Ein solcher Aufbau wird daher als unflexibel angesehen. 

Im SIP-Protokoll wird dieses Problem von Proxys übernommen, die die Aufgabe einer Vermittlungsstelle einnehmen und später im Detial erläutert werden. Ein Proxy kann einen Location Service enthalten, der ankommende SIP-Pakete an das Telefon des angerufenen Teilnehmers weiterleitet oder an einen anderen Proxy weiterleitet, falls sich der Benutzer außerhalb des eigenen Adressbereichs befindet. Zusätzlich können Konferencen, Voice-Mail und Anrufweiterleitungen Teil eines VoIP System sein. 

Da die klassische Telefonie weiterhin neben VoIP Bestand hat, wird versucht mit zusätzlichen Komponenten, den Gateways, eine Verbindung zwischen den beiden Telefonsystemen herzustellen. 


\subsection{Einflussfaktoren auf die VoIP-Qualität}
Die wichtigsten QoS-Anforderungen, die VoIP an IP-Netze stellt, betreffen:
\begin{itemize}
	\item die Bandbreite von virtuellen Verbindungen zwischen IP-Telefonen,
	\item die Ende-zu-Ende-Verzögerung des Sprachsignals (Delay),
	\item die Schankung der Übermittlungszeit (Jitter) und
	\item die Paketverlustrate (Packet Loss Rate)
\end{itemize}

\subsubsection{Ende-zu-Ende-Verzögerung (Delay)}
Da bei VoIP die Sprache zuerst digitalisiert und dann enstsprechend codiert wird, ist dabei die Qualität des übertragenen codierten Sprachsignals abhängig von der Bandbreite für die virtuelle Verbindung zwischen den IP-Telefonen. Ein wichtiger Faktor ist auch die Ende-zu-Ende-Verzögerung des Sprachsignals. Darunter versteht man die Zeitspanne, die ein Sprachsignal vom Mund eines Sprechers bis zum Ohr eines Hörers benötigt. Die Ende-Zu-Ende-Verzögerung entsteht vor allem durch die Zwischenspeicherung der IP-Pakete in den Routern, die sie auf ihren Wegen durch das Netz zu durchalufen haben. Jeder Router benötigt Zeit, um den Header im IP-Paket zu interpretieren und die entsprechende Routing-Entscheidung zu treffen. Trifft ein Paket unterwegs auf einen überlasteten Route, muss es einige Zeit in der Warteschlnage vor der Leitung verbringen und wird im Extremfall sogar ganz verworfen. Eine große Ende-zu-Ende-Verzögerung beinträchtigt den Charakter eines Telefongespräches stark. 

\subsubsection{Schwankung der Übermittlungszeit (Jitter)}
Da die einzelnen IP-Pakete auf einer Verbindung zwischen IP-Telefonen in der Regel auf unterschiedlichen Wegen übermittelt werden, kann ihre Übermittlungszeit recht unterschiedlich sein. Die Schwankungen der Übermittlungszeit werden Jitter genannt. Die Synchronität bei VoIP lässt jedoch kein Jitter zu. Um die Schwankungen auszugleichen, wird beim Empfänger ein spezieller Puffer implementiert. Man bezeichnet einen derartigen Puffer als Jitter-Ausgleichspuffer(Playout Buffer)

\subsubsection{Paketverlustrate (Packet Loss Rate)}
Die Verluste von IP-Paketen mit Sprache während der Übermittlung mindern die Qualität ebenso. Die Anzahl der Paketverluste in einer bestimmten Zeitperiode wird mit dem Parameter Paketverlustrate angegeben. Paketverluste können durch überlastete Router im IP-Netz oder auch durch einen "`schlecht"'  dimensionierten Jitter-Ausgleichspuffer entstehen. Im Gegensatz zu reinen Datenanwendungen, ist der Verlust eines IP-Pakets bei der Sprachübertragung nciht besonders tragisch. Zu viele Paketverluste jedoch machen sich in einem Telefongespräch allerdings sehr störend als Unterbrechungen bemerkbar. 

Da die Sprachkommunikation in Echtzeit verläuft, gilt die Wiedergabe eines Sprachsignals am Ziel als qualitativ schlecht, wenn sie einem zu großen Zeitverzug erfolgt. Für die Ende-zu-Ende-Verzögerung $T_{EE}$(End-to-End-Delay) des Sprachsignals werden daher Grenzwerte gesetzt. Nach dem ITU-T-Dokument G.114 wird die VoIP-Qualität wie flogt klassifiziert:
\begin{itemize}
	\item $T_{EE}$ kleiner als 150ms: akzeptabel für alle Benutzer,
	\item $T_{EE}$ zwischen 150ms und 300ms: akzeptabel, aber mit Einschränkungen (nicht für empfindliche Benutzer), 
	\item $T_{EE}$ größer als 300ms: nicht akzeptabel. 
\end{itemize}


\subsection{VoIP-relevante Sprachcodierungsverfahren}
Es gibt mehrere Sprachcodierungsverfahren, die bei VoIP verwendet werden können. Man unterscheidet zwischen Abtastwert-orientierten Codierungsverfahren, die zwar gute Sprachqualität garantieren aber Bitraten haben die größer als 16 Kbit/s sind und Segment-orientierten Codierungsverfahren die zwar geringe Bitraten haben aber dafür nur eine schlechte bis gute Sprachqualität bieten. 

Obwohl die Qualität quantitativ durch Parameter, wie die Laufzeit der IP-Pakete(Delay), die Laufzeitunterschiede(Jitter) und die Verlustrate von IP-Paketen im Netz beinflusst wird, sagen diese Parameter nichts über die eigentliche Sprachqualität aus. Die eigentliche Sprachqualität wird nach der MOS (Mean Opinion Score) - Skala  gemessen. Diese unterscheidet Aspekte wie Verständlichkeit der Sprache, Akzeptanz der Lautstärke sowie die Akzeptanz der Laufzeitschwankungen und Echos. 

%TODO TABELLE ÜBER MOSS S147
%TODO Tabelle mit Codecs

Eine Analoge Sprachübertragung kommt auf einen MOS-Wert von 3.5 bis 4. Hochwertige VoIP-Implementierungen bieten eine Sprachqualität zwischen 3.8 und 4.4 je nach verwendeter Sprachcodierung. Dabei bieten VoIP-Systeme mindestens die Qualität eines herkömmlichen analogen Telefonnetzes. 


\section{Session Initiation Protokoll (SIP)}
Das \textit{Session Initiation Protocol} wurde zuerst im Jahr 1999 als RFC 2543 eingeführt und im Jahr 2002 in den RFCs 3262-3265 weiter spezifiziert. Das SIP Protokoll ermöglicht es zwischen kommunizierenden Rechner über ein IP-Netz eine \textit{Session (Sitzung)} für die Übermittlung von Echtzeitmedien aufzubauen. Die Session stellt einen logischen Kanal dar, über den die Echtzeitmedien mit Hilfe des RTP Protokolls transportiert werden. SIP wurde bisher weitgehend nur als \textit{Signalisierungsprotokoll} in VoIP Systemen benutzt. SIP definiert bestimmte Nachrichten für den Auf- und Abbau von Sitzungen. Es ist einfach konzipiert und für Menschen leicht lesbar, da es in Anlehnung an das erfolgreiche Internet Protokoll HTTP entwickelt worden ist. 

\subsection{SIP Building Blocks}
% Über komponenten eines SIP Systems schreiben
In der Architektur sind folgende Systemkomponenten definiert:
\begin{itemize}
	\item User Agent
	\item Proxy Server
	\item Redirect Server
	\item Registrar
\end{itemize}

\textbf{User Agent (UA):}User Agents sind alle SIP-fähigen Endgeräte. Diese sind SIP-Telefone, Softphones oder andere Anwendungen und Hardware die nach dem SIP Protokoll kommunizieren. Dabei besteht ein UA intern aus einem User Agent Client (UAC), der Anfragen mittels Nachrichten stellt und einem User Agent Server (UAS), der Anfragen entgegennimmt. Für die einfachste Form des Verbindungsaufbaus genügen zwei User Agents. Wobei jeder der UAS jeweils ein UAS und UAC sein kann. 

\textbf{Proxy Server:} Proxy Server dienen primär dem Routing und der Weiterleitung der SIP-Nachrichten. Zwischen zwei UA können beliebig viele Proxy Server liegen. Proxy Server können Rechtemanagement durchführen und ermitteln ob ein Benutzer berechtigt ist einen Anruf durchzuführen (Authentification). Es werden zwei Arten von Proxy Servern unterschieden, zum einen der statful Proxy, der Verbindungszustände zwischen den UA speichert und zum anderen der stateless Proxy, der SIP Nachrichten lediglich weiterleitet.  Der Verbindungsauf- und Abbau läuft bei SIP in der Regel über einen SIP Proxy Server ab, vor allem wenn sich Benutzer in Verschiedenen Domänen befinden. Der eigentliche Medienfluss findet jedoch direkt zwischen den User Agents ab. 

\textbf{Redirect Server:} Ein Redirect Server dient selber als UAS und beantwortet Lokationsanfragen eines UAC indem er diese aus einer angeschlossen Lokationsdatenbank bezieht. Im Unterschied zum Proxy Server leitet er ankommende Anfragen nicht an einen UAC weiter sondern, verweist per Nachricht lediglich auf eine mögliche Lokation des gesuchten UAC. 

\textbf{Registrar:} Der Registrar oder Location Server, speichert lediglich Aufenthaltsorte in Form von SIP-Adressen, nimmt aber an der SIP-Kommunikation zwischen den User Agents nicht teil. User Agents registrieren sich mit ihrem Aufenthaltsort bei einem Proxy Server, der die Information dann an den Registrar übermittelt. Somit kann die Mobilität von Teilnehmern ermöglicht werden. 

\subsection{Aufbau}
Die SIP-Nachrichten werden textbasiert aufgebaut. Jede nachricht setzt sich aus einer Start-Zeile, einem \textit{Message Header} und einem \textit{Message Body} zusammen, wobei der \textit{Message Body} optional ist. Eine SIP-Nachricht stellt entweder einen Request (eine Anforderung) von einem Initiator der Kommunikation oder einen Response(eine Antwort) von Partner an den Initaitor dar. Somit gibt es nur zwei Arten 

von SIP Nachrichten:
\begin{itemize}
	\item \textit{Request}
	\item \textit{Response}
\end{itemize}

Sowohl \textit{SIP-Responses} als auch \textit{SIP-Requests} sind ähnlich aufgebaut und haben die folgende Struktur:

% Bild vom SIP Message

Die Start-Zeile (\textit{Status-Line}) besteht bei den Requests aus einer Angabe des Request-Typs z.B. INVITE, einer Request-URI als Ziel-Adresse und der SIP-Version. Bei einem Response enthält die \textit{Status-Line} die SIP-Version und einen \textit{Status-Code} der den Typ definiert der Nachricht definiert. Beide Typen von Nachrichten enthalten mehrere Header-Felder von den folgende besonders hervorzuheben sind:
\begin{itemize}
	\item From: Dieses Feld enthält einen Namen und eine URL, die den Absender eindeutig identifizieren soll. 
	\item To: Der To-Header identifiziert den logischen Empfänger der Anfrage und sollte beim entspricht der URL in der Anfragezeile. Diese Headerzeile ist ähnlich der des From-Headers aufgebaut.
	\item Contact: Contact gibt eine SIP-URI an, unter der die Gegenstelle für weitere
Anfragen erreicht werden kann. Das Format entspricht dem der To- und From-
Header. Ein Parameter für diese Headerzeile ist \textit{expires}, der die Zeit in Sekunden angibt, bis der Kontakt nicht mehr verfügbar ist.
	\item Call-ID: Diese Identifiziert den Anruf. Jeder Anruf enthält eine ID die sich aus siner Zufallszahl und dem Namen des Anrufenden enthält. 
\end{itemize}


\subsubsection{Request Typen}
In der Spezifikation RFC 3261 werden sechs Request-Typen definiert, die jedoch inzwischen um weitere Request Typen erweitert wurden:
\begin{itemize}
	\item INVITE: Mit INVITE initiert ein IP-Telefon einen neuen Anruf. Eine INVITE Nachricht enthält die SIP-Adresse von beiden Teilnehmern, einen Subject (Grund) und dessen Priorität.
	\item BYE: Mit BYE wird der Abbau der bestehenden VoIP-Verbindung zwischen zwei Teilnehmern initiiert.
	\item ACK: ACK dient als "`positive"' Bestätigung mit der die Annahme eines ankommenden Anrufes bestätigt wird.
	\item OPTIONS: Mit dieser Nachricht kann man die Fähigkeiten eines Teilnehmers befragen (\textit{Media Capabilities}), die aussagen welche Arten von Medien empfangen werden können und welche Verfahren zu Codierung dieser Medien unterstützt werden.
	\item CANCEL: Mit CANCEL kann eine bereits initiierte VoIP-Verbindung abgebrochen werden und vorzeitig beendet werden. 
	\item REGISTER: Mit REGISTER werden dem \textit{Registrar} Informationen über die Lokation des Teilnehmers mitgeteilt. 
\end{itemize}

Ausgewählte erweiterte Request-Typen, die in zusätzlichen RFCs(3428,3265) nachträglich definiert wurden:

\begin{itemize}
	\item MESSAGE :Mit MESSAGE Nachrichten kann Inhalt in der form von requests MIME (\textit{Multimedia Internet Message Extensions}) Nachrichten übertragen werden.  MESSAGE Nachrichten initiieren keinen SIP Dialog und werden üblicherweise wie normale Kurznachrichten verstanden. 
	\item SUBSCRIBE, PUBLISH und NOTIFY: SIP kann verwendet werden, um bestimmt Ereignisse zu übermitteln. Hierfür sind die Nachrichten SUBSCRIBE, PUBLISH  und NOTIFY eingeführt worden. So kann z.B. die Anwesenheit eines Teilnehmers von weiteren Teilnehmern mit einer SUBSCRIBE Nachricht abonniert werden. Geht dieser Teilnehmer online so benachrichtigt er alle anderen Teilnehmer mit einer PUBLISH Nachricht, an den REGISTRAR. Dieser sendet NOTIFY Nachrichten an alle Abonenten des Anwenders.  
\end{itemize}

\subsubsection{Response Typen}
Im RFC 3261 werden ebenfalls sechs Response Klassen spezifiziert, bei denen dem Absender des Requests eine Response signalisiert wird.
\begin{itemize}
	\item \textit{Informational}: Eine 1xx Nachricht wird teilt mit dass der Request weiter bearbeitet wird.
	\subitem 100: Trying - der Empfänger ist dabei die Empfangene Nachricht zu verarbeiten und eine endgültige Antwort steht noch aus.
	\subitem 180: Ringing - dem Anrufenden wird mitgeteilt dass der eingehende Anruf über einen Klingelton signalisiert wird.
	\item \textit{Success}: Eine 2xx Nachricht teilt mit dass der Request erfolgreich empfangen und akzeptiert wurde. Der Response besteht nur aus der 200 OK Nachricht
	\item \textit{Redirection}: Eine 3xx Nachricht signalisiert dem Absender eines Requests, dass weitere Aktionen bei der Bearbeitung des Requests nötig sind und enthält folgende Subtypen:
	\subitem 301 Moved Permanently 
	\subitem 302 Moved Temporarily 
	\item \textit{Client Error:} Eine 4xx Nachricht teilt mit dass der Request eine falsche Synax hat oder nicht ausgeführt werden kann. 
	\subitem 400 Bad Request
	\subitem 401 Unauthorized - Der 
	\subitem 403 Forbidden - Der Anruf ist nicht zulässig.
	\subitem 404 Not Found - Der Benutzer ist nicht erreichbar oder kann nicht gefunden
	werden.
	\subitem   486 Busy Here - Indiziert dass der Angerufene gerade in einem Gespräch ist und den Anruf nicht annehmen kann.
	\item \textit{Server Error}: Eine 5xx Nachricht teilt mit dass der Server nicht in der Lage war den Request auszuführen. Einige Beispiele sind:
	\subitem 500 Internal Server Error
	\subitem 505 SIP Version not supported
	\item \textit{Global Failure}: Eine 6xx Nachricht teilt mit dass der Request auf keinem der Server des Netzes ausgeführt werden konnte. 
\end{itemize}

\subsection{Rufaufbau, Verbindung, Rufabbau}

% Grafik über Ruffaufbau

Teilnehmer A möchte zu Teilnehmer B eine Verbindung herstellen. Dazu sendet er eine SIP-Nachricht INVITE an Teilnehmer B. Die Nachricht enthält die Beschreibung der RTP-Session nach dem SDP Protokoll und alle notwendigen Angaben, wie z.B. die Sprachkodierung, damit Teilnehmer B Prüfen kann ob eine Session hergestellt werden kann. 
Falls Teilnehmer B die Verbindung annehmen kann, klingelt das angerufene IP-Telefon von Teilnehmer B, dies wird mit der SIP-Response 180 Ringing signalisiert. 
Hat nun Teilnehmer B den Hörer abgehoben, sendet er einen SIP-Response 200 OK der vom Teilnehmer A mit der Nachricht ACK bestätigt wird. Mit dem Empfang der ACT Nachricht von Teilnehmer B, ist die logische Verbindung abgeschlossen. Nun kann eine Verbindung nach dem Protokoll RTP verlaufen und es besteht eine Session zwischen den Teilnehmern. 
Die bestehende RTP-Session kann von beiden Seiten beendet werden. Beendet Teilnehmer B durch das Absenden der SIP Nachricht BYE die Session, bestätigt Teilnehmer A den Empfang der Nachricht mit der SIP-Response 200 OK. Mit dem Empfang von 200 OK beim IP Telefon des Teilnehmers B wird die Session beendet. 

\subsection{Registrierung der Lokation von Teilnehmern}

% Grafik über Registrierung

SIP definiert einen speziellen Server, der als Registrar bezeichnet wird. Diese Komponente wird generell in einem Proxy Server bzw. in einem Redirect-Server untergebracht. Ein Registrar enthält die Angaben hinsichtlich der Lokation von Teilnehmern in einer Domain. 

Dadurch, dass ein Teilnehmer mobil sein kann und verschiedene Clients benutzen kann, können ihm auch verschiedene Lokationen zugeordnet werden und so kann er seine aktuelle Lokation beim Registrar anmelden. Hierfür wird die Request Nachricht REGISTER verwendet. Mit dieser Nachricht kann jeder Teilnehmer die Umleitung der bei ihm ankommenden Anrufe selbst veranlassen. 

Möchte ein Teilnehmer mit der SIP Adresse thomasp@uni-mannheim.de in seiner Heimat-Domain uni-mannheinm entgegennehmen so wird an den Registrar, z.B. registrar.uni-mannheim.de mit der Request Nachricht REGISTER dieser Wunsch mitgeteilt. Relevante Felder der Nachricht enthalten die Herkunft (From), die Lokation des Benutzers(Contact) und die Gültigkeit der Nachricht(Expires). Wechselt der Benutzer vor Ablauf der Expire Zeit seine Lokation so wird der Registrar mit einer weiteren Nachricht darüber aktualisiert. Der Registrar bestätigt den Empfang der Nachrichten jeweils mit einer ACK Nachricht. Ebenso ist eine Registrierung über eine andere Person möglich, so kann z.B. die Sekretärin die aktuelle Lokation ihres Chefs aktualisieren. 

\subsection{Konferenzschaltungen}


\subsection{Instant Messaging zwischen Teilnehmern}

% Grafik eines Messaeg versands.

Als Instant Messaging wird im allgemeinen ein Dienst zur sofortigen Übermittlung von Nachrichten zwischen Teilnehmern eines Netzwerks verstanden. Es existieren viele proprietäre Protokolle wie IRC, XMPP, SLC, OSCAR. Auch bei SIP wurde in den RFCs 3860,3428 und 3265 ein Protokoll für das Instant Messaging definiert: SIMPLE (SIP for Instant Messagingn and Presence). Eine SIP MESSAG Transaktion kann sowohl über einen PROXY laufen als auch direkt zwischen den UACs stattfinden. Möchte Teilnehmer A eine Nachricht an Teilnehmer B verschicken so wird diese mittels der MESSAGE Nachricht versendet und vom Empfänger mit einer ACK Nachricht bestätigt. Die wichtigsten Felder der MESSAGE Nachricht sind das Empfänger Feld(To) der Typ des Inhalts(Content-Type), dessen Länge(Content-Length) und der Inhalt selbst(Body). 

\subsection{Präsenzfunktion von Teilnehmern}

% Grafik über Publish Subscribe

Die SIP Präsenzfunktion dient zur Anzeige des Präsenzstatus anderer Teilnehmer. Die Verwendung eines Präsenzstatus ist in vielen Instant Messaging Anwenungen weit verbreitet jedoch und in verschiedenen Protokolle etabliert IMPS, XMPP. SIP besitzt eine Eigene Erweiterung für Ereignisse die in den RFCs 3265 und 3903 fediniert wurde. Diese Beinhaltet die Nachrichtentypen PUBLISH, SUBSCRIBE und NOTIFY. 

Möchte ein Teilnehmer ein Ereignis wie z.B. seine Statusänderung veröffentlichen, so schickt er eine PUBLISH Nachricht an den Presence-Server, der üblicherweise Teil eines Proxys ist. Dabei enthält die Nachricht den Event Typ in einem Header der Nachrichten Header, die relevanten PUBLISH Informationen im XML Format jedoch im Body Feld. Grundsätzlich sind beliebige Formate nutzbar wobei ein Standard speziell für die Präsenzinformation PIDF (Presence Information Data Format) existiert. Ein solches PIDF Tupel kann Beispielsweise den Namen des Teilnehmers, seinen Status und eine NTP Zeit enthalten. 

Möchte ein Teilnehmer die Ereignisse eines bestimmten Typs abonnieren z.B. presence oder nur von bestimmten Teilnehmern (SIP-URI) so versendet er an den Presence-Server eine SUBSCRIBE Nachricht.Die Länge des Dialogs wird durch das Laufzeit-Feld deklariert(Expires). Möchte der Teilnehmer sein Abonnement vorzeitig kündigen so kann er eine SUBSCRIBE Nachricht mit der Laufzeit 0s verschicken. Der Erhalt einer solchen Nachricht führt dazu dass ein Dialog zwischen Presence Server und dem Teilnehmer eingeleitet wird. 
Eine NOTIFY Transaktion informiert nun den Abonnenten über seine abonnierten Ereignisse wie z.B. den Präsenzstatus eines Teilnehmers. 


\section{Session Description Protokoll}
Das Session Description Protokoll wird vom Signalisierungsprotokoll SIP dazu verwendet, die Eigenschaften des Medienstroms sowie den Verwendeten Codec , Transportprotokoll und Zieladresse mit Port festzulegen. 

\subsection{Aufbau}
SDP ist ein textbasiertes Format in dem die Eigenschaft und der Wert in Textform in der Nachricht festgehalten werden. Der Message Body enthält die Besonderheiten der RTP-Session, die durch das SDP (Session Description Protocol) festgelegt wird. Der Message Body setzt sich aus der Spezifikation der RTP-Session, der Zeitbeschreibung und der Medienbeschreibung zusammen. 

% Bild der SDP message

Die Beschreibung der RTP-Session wird mit den folgenden Parametern definiert:
\begin{itemize}
	\item v: Die Zeile gibt die verwendete RTP Version an.
	\item o: Die Zeile enthält den Initiator der Nachricht an:
	\subitem $\left\langle username \right\rangle$: den Namen des Initiators der Session
	\subitem $\left\langle session id \right\rangle$: die Identifikation der Session, meistens der NTP-Stempel.
	\subitem $\left\langle network type \right\rangle$: der Netztyp
	\subitem $\left\langle address type \right\rangle$: der Typ der Quell-IP-Adresse
	\subitem $\left\langle adress \right\rangle$: die Quell-IP-Adresse
	\item s: Die Zeile gibt eine genauere Bezeichnung der Session an z.B. den Namen
	\item t: Die Zeile gibt die Start und Endzeit der Session an. 
	\item m: In der Media Zeile wird angegeben:
	\subitem $\left\langle media \right\rangle$: Hier wird die Medienart (z.B. Audio) definiert.
	\subitem $\left\langle port \right\rangle$: Die Portnummer über den das Medium empfangen wird.
	\subitem $\left\langle transport \right\rangle$: Das verwendete Transportprotokoll
	\subitem $\left\langle fmt list \right\rangle$: Eine List der zulässigen Formate des Mediums. 
	\item a: Hier wird eine Liste angegeben welches Format des Mediums empfangen werden kann. 
\end{itemize}

% Tabelle Buch Seite 155

Eine Übersicht üblicher Codecs ist in der Tabelle xy dargestellt. Den "`klassischen"' Audio Formaten sind feste Nummern zugeordnet. Weiter Typen befinden sich im dynamischen Bereich und können für jede Sitzung zu beliebigen Medienformaten vereinbart werden.

\subsection{Aushandeln der Sitzungsparameter}
Die unter dem Parameter a ausgetauschte Liste der Medienformate entspricht in der Reihenfolge der Präferenzen des des Senders. Der Empfänger eines solchen SDP Nachricht Angebots beantwortet jedes empfangene Medienformat mit einer Korrespondierenden Antwort falls er dieses Medienformat unterstützt. Ein Medienstrom kann vom Empfänger abgelehnt werden, wenn keines der aufgelisteten Medienformate unterstützt wird, indem als Port eine Null gesendet wird. Nach Möglichkeit sollte die Reihenfolge die unterstützten Medienformate aus dem Angebot beibehalten und nicht unterstützte Formate sollten ausgeblendet werden.

Nachdem sich beide Teilnehmer auf die unterstützte Formate geeinigt haben wurden, können beide Seite damit
beginnen, die Mediendaten zu senden. Beide Seiten sollten jeweils das bevorzugte Format senden. 
Während einer Sitzung können die Parameter neu verhandelt werden, indem der gleiche Ablauf mit entsprechend modifizierten SDP-Beschreibungen durchgeführt wird. 

\section{Real-Time Transport Protokoll}
Speziell für die Übermittlung von Sprache, Audio und Video über IP-Netze wurde RTP(Real-time Transport Protocol) bei der IETF entwickelt (2003 RFC 2550). Einerseits stellt RTP ein Transportprotokoll für die Echtzeitmedien dar anderseits kann es als eine Anwendungsart oberhalb des verbindungslosen Protokolls UDP angesehen werden. 

%--grafik s151

Die Wichtigsten Besonderheiten von RTP sind:

\begin{itemize}
	\item Übermittlung von Echtzeitmedien in RTP-Paketen: Echtzeitmedien werden in RTP als eine zusammenhängende Folge von RTP-Paketen über eine RTP-Session übermittelt. 
	\item Garantie der Reihenfolge von RTP-Paketen: RTP nummeriert die übertragenen Pakete mit Echtzeitmedien, sodass ihre richtige Reihenfolge am Ziel wiederhergestellt werden kann, falls sie durch den Transport über das IP-Netz veränert wurde. 
	\item Grantie der Synchronität: RTP vergibt den übertragenen Paketen einen Zeitstempel, sodass die gleichen Zeitabstände am Ziel wiederhergestellt werden können, die beim Absender bestanden. 
	\item Transport unterschiedlicher Formate: Es können unterschiedliche Formate wie Audio, Sprache und Video übertragen werden, die in unterschiedlichen Profiles genau bezeichnet werden. 
\end{itemize}

\subsection{Aufbau von RTP-Paketen}
RTP übermittelt ein Echtzeitmedium als Folge von RTP Paketen , die mit einem vorangestellten UDP-Header in den IP-Paketen transportiert werden. Jedes RTP-Paket enthält einen RTP-Header und einen Payload-Teil. Die Wesentlichen angaben im RTP-Header sind:
%-- grafik  S153

\begin{itemize}
	\item PT: Payload Type: Es wird angegeben, um welches Format es sich beim transportierten Medium handelt, dh. nach welchem Verfahren codiert wurde. Die Möglichen Codierungsarten sind in RFC 3551 festgelegt. 
	\item Timestamp: Der Zeitstempel dient dazu, den Zeitpunkt der Generierung von Payload zu markieren. Der Zeitstempel ist nötig, um die Schwankungen der Übertragungszeit (Jitter) von RTP-Paketen beim Empfänger auszugleichen. 
	\item Sequence Number: Jedes RTP-Paket wird mit einer Sequenznummer versehen, die es dem Emfpänger erlaubt, den Verlust von Paketen festzustellen, bzw. die Reihenfolge wiederherzustellen, falls sie in einer falschen Reihenfolge angekommen sind. 
	\item SSRC: Zur Identifikation der Quelle(Mikrofon, Kamera) dient der SSRC, so müssen zwei verschiedene Quellen unterschiedliche SSRCs haben, um für den Empfänger unterscheidbar zu sein. 
	\item CSRC: Wird optional verwendet un enthält die "`Orginal"'-Quellen der Bitströme falls der SSRC von einem Mixer verändert wurde.
\end{itemize}

\subsection{Payload-Typen}
Die PT Nummern dienen zur Identifikation der einzelnen Audio- und Video-Formate. Da der Nummernraum nicht komplett belegt ist können wietere nummern vergeben werden (dynamische PT-Nummern). Bei der Verwendung von dynamischen PT-Nummern wird die Kompatibilität zwischen Empfänger und Sender mit Hilfe des SDP Protokolls vereinbart. 

-- payload tabelle

\subsection{RTP Control Protokoll}
RTP wird mit RTCP so ergänzt, dass Information über den Verlauf der Kommunikation zwischen Sender und Empfänger, insbesondere über die Qualität der Übertragung, ausgetauscht werden können. 

Die wichtigsten Aufgaben von RTCP sind die Überwachung der Übertragungsqualität: Hierfür werden zwischen Sender und Emfpänger laufend Informationen über die Qualität der Übertragung mittels Sender- und Receiverreports ausgetauscht. Dies Ermöglicht es dem Sender, den von ihm generierten Bitstrom an die Netzbedingungen anzupassen und so Fehler einzugrenzen. 

\subsubsection{Typen und Struktur der RTCP-Pakete}
Beim RTCP werden folgende RTCP-Pakete als Nachrichten verwendet. 
\begin{itemize}
	\item Sender Report (SR)
	\item Receiver Report(RR)
	\item Source Description (SDES)
	\item Abmeldung (BYE)
	\item Applikationsspezifisches Paket (APP)
\end{itemize}

RTCP Pakete beginnen mit einem Header und können unabhängig von anderen bearbeitet werden. Die Reihenfolge der Pakete in einem IP-Paket kann beliebig sein. 
Das SR Paket enthält einen Zeitstempel gemäß der NTP (Network Time Prococol) und beschreibt die Qualität der Übermittlung aus Sicht des Senders. So kann z.B. dem Empfänger die Sende-Datenrate mitgeteilt werden, damit dieser sich im Voraus auf die ankommende Datenmenge einstellen kann. 


\subsection{Silence Supression}
Teilnehmer einer Audio verbindung müssen nicht unbedingt Audiopakete über den RTP Stream senden, falls gerade bei den Teilnehmern Stille herrscht. Diese Funktion wurde im RFT 3389 spezifiziert.

Die Möglichkeit den RTP Paketversand während Stilleperioden zu unterbrechen wird als Stille Unterdrückung ("`Silence Suppression"') oder Stimm Aktivitäts Erekennung("`Voice Activity Detection"') bezeichnet. Ob Silence Suppression eingesetzt wird hängt normalerweise von der Konfiguration der beiden Endpunkte ab, und wurde wird in den RTP Parametern detailierter erklärt. 

%TODO


% Grafik eines RTCP Pakets

In einem Sender Report sind immer enthalten:
\begin{itemize}
	\item NTP-Zeitstempel: Ein Zeitstempel gemäß der NTP Uhrzeit. 
	\item RTP-Zeitstempel: Die NTP-Zeit in Zeiteinheiten der RTP Session, die primär dazu dient um verschiedene Quellen zu synchronisieren.
	\item Gesendete Pakete: Die Anzahl der gesendeten Pakete sowie Bytes.
\end{itemize}

Bei RR Paket werden Werte wie Jitter, Round-Trip-Delay (Hin-und-Zürück-Verzögerung)  oder Paketverlust aus Sicht des Emfpängers berechnet und abgeschätzt. 
In einem Receiver Report sind unter anderm folgende Informationen enthalten:
\begin{enumerate}
	\item Paketverlust: Der Anteil der verlorenen Pakete seit dem letzten Report, als auch die Gesamtanzahl der verlorenen Pakete.
	\item Jitter: Der Jitter wird geschätzt als die Varianz der Ankunftszeitdifferenzen der Pakete. 
	\item Letzter Report: Die verstrichene Zeit seid dem Empfang des letzten Reports.
\end{enumerate}

Die SDES Pakete ermöglichen es, die Quallen mit Namen zu kennzeichnen. Diese Kennzeichnung wird vom Empfänger dazu verwendet mehrere Bitströme einer Quelle, die in getrennten RTP-Sessions übertragen werden wieder zusammenzuführen. Das BYE Paket dient dazu das Ende der Teilnahme an einer Kommunikation anzuzeigen. 

\section{STUN Protokoll} 

Unter STUN (Simple Traversal of User Datagram Protocol Through Network Adress Translators) versteht man ein einfaches Protokoll, dass im RFC 3489 spezifiziert wurde. Es erlaubt Anwendungen festzustellen ob sie sich hinter einer Firewall oder einem Router mit NAT (Network Adress Translator) befinden und um welche Kategorie von Router es sich handelt. Ebenso ist es mit STUN möglich seine öffentliche IP Adresse herauszufinden. 
STUN kann vielen vor allem Peer-to-Peer Protokollfamilien helfen, die durch NATs in ihrer Funktionsweise behindert werden. Beispiele solcher Protokolle sind generell alle Peer-to-Peer Protokolle die Multimediakommunikation, Datenaustausch oder Spielen ermöglichen. 

Die typische STUN Konfiguration beinhaltet einen STUN Client, der in einem privaten Netzwerk beheimatet ist. Dieses Netzwerk wird mit dem Internet durch einen NAT verbunden. Ein weiteres privates Netzwerk das ebenfalls durch einen NAT verbunden ist, beheimatet einen weiteren STUN Client. Der STUN Server befindet sich im öffentlichen Internet. Möchte nun eine Client- Anwendung seine öffentliche IP Adresse und Port erfahren auf der sie Daten empfangen kann sendet der STUN Client in der Anwendung einen STUN "`Shared Secret Request"' an den STUN Server und dann einen Binding Request. Dafür muss dem Client mindestens die Adresse eines öffentlichen STUN Servers bekannt sein. Ein Binding Request wird benutzt um die Anwesenheit eines NATs festzustellen und um die öffentliche IP Adresse und Port zu erfahren, die der NAT generiert hat. Vom STUN Server wird ein solcher Request wird mit einer Binding Response beantwortet die genau diese Daten zurück an den Client schickt. Erhält nun ein STUN-Client eine Binding Response vergleicht er die IP-Adresse und den Port mit seiner lokalen IP Adresse und Sendereport und kann so feststellen ob es sich hinter einem NAT befindet. Nachdem beide Clients ihre öffentlichen IP-Adressen und Port Paare kennen sind sie in der Lage direkt miteinander zu kommunizieren. Eine detaillierter schematischer Ablauf einer STUN Transaktion wird in Abblildung xy dargestellt.

%Grafik von STUN Transaktion


\section{Skype}
\subsection{Registrierung und Login}
\subsection{Rufsignalisierung und Sprachübertragung}
\subsection{Technologie von Skype}
\subsubsection{Verbindungsstruktur}
\subsubsection{Sicherheit}
\subsubsection{Konferenzen}

DO I REALLY NEED TO TALK ABOUT SKYPE??

1. The protocol is proprietary unlike open standard such as SIP.
2. It provides a single service wich is making calls or instant messages and not a architecture for new services
3. Most importantly it has centrlized elements for login authentication 
\cite{schulzrinne05}

